<!DOCTYPE html> 
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Há»‡ thá»‘ng Dá»± bÃ¡o ThiÃªn tai á»¨ng dá»¥ng AI</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- html2canvas + jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* ===================================================
   ğŸŒ¤ SAFE ROUTE AI MAPS â€” iOS Light Blue Theme
   =================================================== */
body{
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text",Roboto,Arial;
  margin:0;padding:0;
  background:#f4f8ff;
  color:#111;
  transition:0.3s;
}
body.dark{background:#000;color:#eee;}
.container{max-width:1150px;margin:auto;padding:16px;}

/* ========== HEADER (iOS Blur Style) ========== */
.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:rgba(245,248,255,0.85);
  backdrop-filter:blur(16px);
  border-bottom:1px solid rgba(0,0,0,0.06);
  box-shadow:0 2px 12px rgba(0,0,0,0.05);
  padding:12px 20px;
  position:sticky;top:0;z-index:50;
  border-radius:0 0 18px 18px;
}
.header-title{
  font-size:20px;
  font-weight:700;
  color:#003366;
}
.header-info{
  display:flex;
  align-items:center;
  gap:16px;
  font-weight:600;
  color:#0066cc;
  font-size:16px;
}
.header-info span{
  display:flex;
  align-items:center;
  gap:4px;
}

/* ========== CONTROL PANEL ========== */
.topbar{
  background:#ffffff;
  border-radius:24px;
  padding:16px 20px;
  box-shadow:0 8px 24px rgba(0,0,0,0.08);
  margin:18px 0;
  display:flex;
  flex-wrap:wrap;
  gap:14px;
  align-items:center;
  border:1px solid #e1e6f3;
}
.top-group{
  display:flex;
  align-items:center;
  flex-wrap:wrap;
  gap:10px;
}
button{
  border:none;
  border-radius:999px;
  padding:9px 15px;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  transition:0.2s;
  box-shadow:0 2px 6px rgba(0,0,0,0.06);
}
button.main{background:#007aff;color:#fff;}
button.success{background:#34c759;color:#fff;}
button.danger{background:#ff3b30;color:#fff;}
button.gray{background:#d1d1d6;color:#111;}
button:hover{opacity:0.85;}
input{
  padding:8px 12px;
  border-radius:999px;
  border:1px solid #cfd7e4;
  background:#f9fbff;
  width:120px;
}
.control-row{
  display:flex;
  align-items:center;
  flex-wrap:wrap;
  gap:10px;
  background:#f3f6ff;
  border:1px solid #e2e8ff;
  border-radius:18px;
  padding:10px 14px;
}
.control-row span.label{
  font-size:13px;
  color:#333;
  font-weight:500;
}
.radius-btn, .ai-btn{
  padding:8px 14px;
  border-radius:999px;
  border:0;
  background:#e5edff;
  color:#1a2a4a;
  font-size:13px;
  font-weight:600;
  cursor:pointer;
}
.radius-btn.active, .ai-btn.active{
  background:#007aff;
  color:#fff;
}

/* ========== BOX ========== */
.box{
  background:#ffffff;
  border-radius:22px;
  padding:16px;
  box-shadow:0 4px 14px rgba(0,0,0,0.06);
  margin-bottom:18px;
  border:1px solid #e5e8f0;
}
#map-main{
  height:520px;
  width:100%;
  border-radius:22px;
  box-shadow:0 8px 25px rgba(0,0,0,0.12);
  margin-bottom:18px;
}
#map-dam{
  height:520px;
  width:100%;
  border-radius:20px;
  box-shadow:0 10px 25px rgba(0,0,0,0.15);
  margin-bottom:20px;
}
.forecast-card{
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-radius:16px;
  padding:10px 14px;
  background:#f1f6ff;
  border:1px solid #d8e2ff;
  margin-bottom:8px;
}
.forecast-date{font-weight:600;color:#002b72;}
.forecast-desc{font-size:13px;color:#333;}
.forecast-rain{font-weight:600;color:#111;}
.small{font-size:13px;color:#555;}

@media(max-width:700px){
  .header{flex-direction:column;align-items:flex-start;gap:6px;}
  .topbar{padding:10px;border-radius:14px;}
}
</style>
</head>

<body>
<!-- ================= HEADER ================= -->
<div class="header">
  <div class="header-info">
    <span>ğŸŒ¡ <b id="live-temp">--Â°C</b></span>
  </div>
  <div class="header-title">ğŸŒª Há»‡ thá»‘ng Dá»± bÃ¡o ThiÃªn tai á»¨ng dá»¥ng AI</div>
  <div class="header-info">
    <span>â± <b id="live-clock">--:--:--</b></span>
  </div>
</div>

<div class="container">

<!-- ========================
     PAGE 1: SAFE ROUTE / AI
     ======================== -->
<div id="page1">

<!-- =============================
     Báº¢NG ÄIá»€U KHIá»‚N (CONTROL PANEL)
     ============================= -->
<div class="topbar">
  <div class="top-group">
    <button onclick="getMyLocation()" class="main">ğŸ“ GPS</button>
    <input id="lat" placeholder="Latitude">
    <input id="lng" placeholder="Longitude">
    <button onclick="loadLocation()" class="main">Hiá»ƒn thá»‹</button>
  </div>

  <div class="top-group">
    <button onclick="simulateDanger()" class="success">ğŸ›Ÿ Simulate</button>
    <button onclick="runFlowAIV2()" class="main">ğŸŒŠ AI DÃ²ng Cháº£y V2</button>
    <button onclick="toggleRadar()" class="main">ğŸŒ Radar</button>
    <button onclick="toggleDarkMode()">ğŸŒ™ Dark</button>
    <button onclick="toggleUIMode()" class="danger">ğŸ“± Giao diá»‡n</button>
  </div>

  <div class="control-row" style="margin-top:10px;">
    <span class="label">ğŸ“ BÃ¡n kÃ­nh phÃ¢n tÃ­ch:</span>
    <button class="radius-btn" data-radius="5" onclick="setRadius(5)">5 km</button>
    <button class="radius-btn" data-radius="10" onclick="setRadius(10)">10 km</button>
    <button class="radius-btn" data-radius="30" onclick="setRadius(30)">30 km</button>

    <span class="label" style="margin-left:12px;">ğŸ¤– Cháº¿ Ä‘á»™ AI:</span>
    <button id="ai-real-btn" class="ai-btn" onclick="setAIMode('real')">AI Tháº­t</button>
    <button id="ai-sim-btn" class="ai-btn" onclick="setAIMode('sim')">AI MÃ´ phá»ng</button>
  </div>

  <div class="top-group" style="margin-top:10px;">
    <button onclick="computeFloodPath()" class="main">ğŸ§­ SafeRoute AI</button>
    <button onclick="computeSafeRouteProV3()" class="main">ğŸ§  SafeRoute Pro V3</button>
    <button onclick="startFloodTimeline()" class="main">â± Flood Timeline AI</button>
    <button onclick="clearFloodPath()" class="danger">âœ– XÃ³a</button>
    <button onclick="exportPDF()" class="gray">ğŸ“„ PDF</button>
    <button onclick="goToDamPage()" class="main">ğŸ” Tra cá»©u Ä‘áº­p</button>
    <button onclick="openSOSForm()" class="danger">ğŸš¨ Gá»­i SOS</button>
    <button onclick="showPage(3)" class="main">ğŸ—º Trung tÃ¢m cá»©u há»™</button>

    <div class="button-group-features">
        <button class="btn blue" onclick="location.href='tracuudapv2.html'">ğŸ” ThÃ´ng tin Ä‘áº­p</button>
        <button class="btn orange" onclick="location.href='v3bao.html'">ğŸ“„ BÃ¡o V2</button>
    </div>

  </div>

  <div id="status" class="small" style="margin-left:auto;font-weight:600;">
    Sáºµn sÃ ng
  </div>
</div>

<!-- =============================
     Báº¢N Äá»’ TRANG 1
     ============================= -->
<div id="map-main"></div>

<!-- =============================
     THá»œI TIáº¾T + PHÃ‚N TÃCH AI
     ============================= -->
<div class="box">
  <h3>ğŸŒ§ ThÃ´ng tin Thá»i tiáº¿t & PhÃ¢n tÃ­ch AI</h3>

  <p>ğŸ“ Vá»‹ trÃ­: <span id="current-location">---</span></p>
  <p>ğŸŒ§ LÆ°á»£ng mÆ°a: <span id="current-rain">---</span> mm</p>
  <p>ğŸ’§ ThÃ´ng lÆ°á»£ng: <span id="current-precip">---</span> mm</p>

  <div id="ai-result"
       class="box"
       style="background:#fffef5;border:1px solid #ffeb99;margin-top:12px;">
    AI chÆ°a cháº¡y â€” chá»n cháº¿ Ä‘á»™ vÃ  báº¥m "SafeRoute AI"
  </div>

  <div class="small" style="margin-top:8px;">
    ChÃº giáº£i:
    <span style="color:#d32f2f">â— vÃ¹ng nguy hiá»ƒm</span> Â·
    <span style="color:#ff9800">â–² hÆ°á»›ng dÃ²ng cháº£y</span> Â·
    <span style="color:#007aff">â€” tuyáº¿n an toÃ n</span>
  </div>
</div>

<!-- ğŸ”¹ BOX: AI DÃ’NG CHáº¢Y V2 + FLOOD TIMELINE -->
<div class="box">
  <h3>ğŸŒŠ Káº¿t quáº£ AI DÃ²ng Cháº£y V2</h3>
  <p id="flow-ai-v2-result">ChÆ°a phÃ¢n tÃ­ch.</p>

  <div style="margin-top:10px;padding-top:10px;border-top:1px dashed #dde3ff;">
    <div class="small" style="margin-bottom:6px;">
      â± <b>MÃ´ phá»ng nÆ°á»›c lan theo thá»i gian (Flood Timeline AI)</b><br/>
      <span id="flood-timeline-label">ChÆ°a cháº¡y mÃ´ phá»ng.</span>
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
      <button class="main" onclick="startFloodTimeline()">â–¶ Cháº¡y mÃ´ phá»ng</button>
      <button class="gray" onclick="stopFloodTimeline()">â¹ Dá»«ng</button>
      <span class="small">Khung thá»i gian: <span id="flood-timeline-step">-</span></span>
    </div>
  </div>
</div>

<!-- =============================
     Dá»° BÃO 3 NGÃ€Y
     ============================= -->
<div class="box">
  <h3>ğŸ“… Dá»± bÃ¡o 3 ngÃ y tiáº¿p theo</h3>
  <div id="forecast"></div>
</div>

<!-- =============================
     Cáº¢NH BÃO DI Táº¢N
     ============================= -->
<div id="evacuation-alert"></div>
<!-- =============================
     CÃ€I Äáº¶T Cáº¢NH BÃO
     ============================= -->
<div class="box">
  <h3>âš™ï¸ CÃ i Ä‘áº·t cáº£nh bÃ¡o di táº£n</h3>

  <p>NgÆ°á»¡ng mÆ°a (mm):</p>
  <input id="evac-threshold" type="number" min="1" style="width:120px;">

  <br><br>

  <p>Chá»n Ä‘iá»ƒm an toÃ n (náº¿u khÃ´ng chá»n, AI tá»± tÃ¬m):</p>
  <select id="evac-point-select"></select>

  <br><br>

  <button onclick="saveEvacSettings()" class="success">ğŸ’¾ LÆ°u cÃ i Ä‘áº·t</button>
</div>

<audio id="alert-sound"
       src="https://www.soundjay.com/button/beep-07.wav"
       preload="auto"></audio>

</div> <!-- END PAGE 1 -->


<!-- ========================
     PAGE 2: TRA Cá»¨U Äáº¬P
     ======================== -->
<div id="page2" style="display:none;">

  <!-- TOPBAR TRANG 2 -->
  <div class="topbar">
    <div class="top-group">
      <button onclick="showPage(1)" class="gray">ğŸ”™ Quay láº¡i</button>
      <button onclick="toggleDamRadar()" class="main">ğŸŒ§ Radar mÆ°a</button>
      <button onclick="analyzeRiskAuto()" class="danger">âš ï¸ PhÃ¢n tÃ­ch nguy cÆ¡</button>
    </div>

    <div class="top-group">
      <span class="small">ğŸ“ BÃ¡n kÃ­nh tÃ¬m Ä‘áº­p:</span>
      <button class="dam-radius-btn" data-radius="10" onclick="setDamRadius(10)">10 km</button>
      <button class="dam-radius-btn" data-radius="20" onclick="setDamRadius(20)">20 km</button>
      <button class="dam-radius-btn" data-radius="50" onclick="setDamRadius(50)">50 km</button>
      <button class="dam-radius-btn" data-radius="100" onclick="setDamRadius(100)">100 km</button>
      <button class="dam-radius-btn" data-radius="200" onclick="setDamRadius(200)">200 km</button>
    </div>

    <div id="status-dam" class="small" style="margin-left:auto;font-weight:600;">
      Sáºµn sÃ ng
    </div>
  </div>

  <!-- Báº¢N Äá»’ TRANG 2 -->
  <div id="map-dam"></div>

  <!-- Káº¾T QUáº¢ TRA Cá»¨U -->
  <div class="box">
    <h3>ğŸ“‹ Danh sÃ¡ch Ä‘áº­p trong bÃ¡n kÃ­nh <span id="dam-radius-label">10</span> km</h3>
    <div id="dam-list" style="max-height:240px;overflow:auto;font-size:15px;"></div>
  </div>

  <!-- Cáº¢NH BÃO & PHÃ‚N TÃCH -->
  <div class="box">
    <h3>ğŸ§  PhÃ¢n tÃ­ch rá»§i ro khu vá»±c</h3>
    <p><b>ğŸ“ Tá»a Ä‘á»™:</b> <span id="dam-location-label">---</span></p>
    <p><b>ğŸ” Cao Ä‘á»™:</b> <span id="dam-elev-label">---</span> m</p>
    <p><b>ğŸŒ§ LÆ°á»£ng mÆ°a hiá»‡n táº¡i:</b> <span id="dam-rain-label">---</span> mm</p>
    <p><b>âš ï¸ Káº¿t luáº­n AI:</b> <span id="dam-risk-label" style="font-weight:600;color:#d32f2f;">---</span></p>
  </div>

</div> <!-- END PAGE 2 -->


<!-- ========================
     PAGE 3: TRUNG TÃ‚M Cá»¨U Há»˜ (RESCUE HUB)
     ======================== -->
<div id="page3" style="display:none;">

  <div class="topbar">
    <div class="top-group">
      <button onclick="showPage(1)" class="gray">ğŸ”™ Quay láº¡i</button>
      <button onclick="refreshSOSData()" class="main">ğŸ”„ Cáº­p nháº­t SOS</button>
    </div>
    <div id="status-rescue" class="small" style="margin-left:auto;font-weight:600;">
      Sáºµn sÃ ng
    </div>
  </div>

  <div id="map-rescue" style="height:520px;width:100%;border-radius:20px;box-shadow:0 10px 25px rgba(0,0,0,0.15);margin-bottom:18px;"></div>

  <div class="box">
    <h3>ğŸš¨ Danh sÃ¡ch tÃ­n hiá»‡u SOS</h3>
    <div id="sos-list" style="max-height:260px;overflow:auto;font-size:15px;"></div>
  </div>

</div>

</div> <!-- END CONTAINER -->
<script>
// ===================================================
// ğŸŒª SAFE ROUTE AI MAPS â€” PAGE 1 (CHÃNH)
// ===================================================

// ========== BIáº¾N TOÃ€N Cá»¤C TRANG 1 ==========
let map, userMarker, safeRouteLine, floodArrows = [];
let currentLat = null, currentLng = null;
let safePoints = [];
let aiMode = "sim";
let radiusKm = 10;
let radarLayer = null;

// --- AI DÃ²ng Cháº£y V2 ---
let flowV2Layers = [];
let flowV2FloodPolygon = null;

// ========== KHá»I Táº O MAP ==========
function initMap() {
  map = L.map("map-main").setView([18.3, 105.7], 10);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18
  }).addTo(map);
}
initMap();

// ========== GPS ==========
function getMyLocation() {
  if (!navigator.geolocation) {
    alert("TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ Ä‘á»‹nh vá»‹ GPS.");
    return;
  }
  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude } = pos.coords;
    document.getElementById("lat").value = latitude.toFixed(5);
    document.getElementById("lng").value = longitude.toFixed(5);
    loadLocation();
  }, err => alert("KhÃ´ng láº¥y Ä‘Æ°á»£c vá»‹ trÃ­: " + err.message));
}

// ========== LOAD LOCATION ==========
function loadLocation() {
  currentLat = parseFloat(document.getElementById("lat").value);
  currentLng = parseFloat(document.getElementById("lng").value);
  if (isNaN(currentLat) || isNaN(currentLng)) {
    alert("Vui lÃ²ng nháº­p tá»a Ä‘á»™ há»£p lá»‡.");
    return;
  }
  if (userMarker) map.removeLayer(userMarker);

  userMarker = L.marker([currentLat, currentLng]).addTo(map)
    .bindPopup("ğŸ“ Vá»‹ trÃ­ cá»§a báº¡n").openPopup();

  map.setView([currentLat, currentLng], 13);
  updateWeather();
}

// ========== WEATHER ==========
async function updateWeather() {
  if (!currentLat || !currentLng) return;
  try {
    const url = 
`https://api.open-meteo.com/v1/forecast?latitude=${currentLat}&longitude=${currentLng}&hourly=temperature_2m,precipitation&current_weather=true&forecast_days=3&timezone=auto`;

    const res = await fetch(url);
    const data = await res.json();

    const temp = data.current_weather?.temperature ?? "--";
    document.getElementById("live-temp").innerText = `${temp}Â°C`;

    document.getElementById("current-location").innerText = 
      `${currentLat.toFixed(3)}, ${currentLng.toFixed(3)}`;

    document.getElementById("current-rain").innerText = 
      data.hourly.precipitation[0] ?? 0;

    document.getElementById("current-precip").innerText =
      (data.hourly.precipitation.reduce((a,b)=>a+b,0)/data.hourly.precipitation.length).toFixed(1);

    // Forecast 3 days
    const forecastDiv = document.getElementById("forecast");
    forecastDiv.innerHTML = "";
    const days = [...Array(3)].map((_,i)=>{
      const t = data.hourly.temperature_2m.slice(i*24,(i+1)*24);
      const r = data.hourly.precipitation.slice(i*24,(i+1)*24);
      const avgT = (t.reduce((a,b)=>a+b,0)/t.length).toFixed(1);
      const sumR = r.reduce((a,b)=>a+b,0).toFixed(1);
      return {day: i+1, temp: avgT, rain: sumR};
    });

    days.forEach(d=>{
      forecastDiv.innerHTML += `
        <div class="forecast-card">
          <div class="forecast-date">NgÃ y +${d.day}</div>
          <div class="forecast-desc">Nhiá»‡t Ä‘á»™ TB: ${d.temp}Â°C</div>
          <div class="forecast-rain">MÆ°a: ${d.rain}mm</div>
        </div>`;
    });

  } catch (e) {
    console.error(e);
  }
}

// ========== CLOCK ==========
function startClock() {
  setInterval(()=>{
    const now = new Date();
    document.getElementById("live-clock").innerText = 
      now.toLocaleTimeString("vi-VN");
  }, 1000);
}
startClock();

// ========== SET RADIUS & AI MODE ==========
function setRadius(km) {
  radiusKm = km;
  document.querySelectorAll(".radius-btn").forEach(btn=>btn.classList.remove("active"));
  const btn = document.querySelector(`.radius-btn[data-radius='${km}']`);
  if(btn) btn.classList.add("active");
}
function setAIMode(mode) {
  aiMode = mode;
  document.querySelectorAll(".ai-btn").forEach(b=>b.classList.remove("active"));
  document.getElementById(mode==='real'?'ai-real-btn':'ai-sim-btn').classList.add("active");
}

// ========== RADAR LAYER ==========
function toggleRadar() {
  if (radarLayer) {
    map.removeLayer(radarLayer);
    radarLayer = null;
  } else {
    radarLayer = L.tileLayer(
      "https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=439d4b804bc8187953eb36d2a8c26a02",
      {opacity:0.5}
    ).addTo(map);
  }
}
// ========== SAFE ROUTE AI ==========
async function computeFloodPath() {
  if (!currentLat || !currentLng) {
    alert("ChÆ°a cÃ³ vá»‹ trÃ­. HÃ£y báº­t GPS hoáº·c nháº­p tá»a Ä‘á»™ trÆ°á»›c.");
    return;
  }
  setStatus("ğŸ” Äang phÃ¢n tÃ­ch Ä‘Æ°á»ng Ä‘i an toÃ n...");

  safePoints = [];
  for (let i = 0; i < 6; i++) {
    const angle = (Math.PI * 2 / 6) * i;
    const lat = currentLat + (radiusKm/111) * Math.cos(angle);
    const lng = currentLng + (radiusKm/111) * Math.sin(angle);
    safePoints.push({lat,lng});
  }

  const routes = await Promise.all(safePoints.map(async (p)=>{
    try{
      const url = `https://router.project-osrm.org/route/v1/driving/${currentLng},${currentLat};${p.lng},${p.lat}?overview=full&geometries=geojson`;
      const res = await fetch(url);
      const data = await res.json();
      if(!data.routes || !data.routes[0]) return null;
      return {p,dist:data.routes[0].distance,geo:data.routes[0].geometry};
    }catch(err){
      return null;
    }
  }));

  let valid = routes.filter(r=>r);

  if(valid.length===0){
    let bestPoint = safePoints[0];
    let bestDist = distanceKm(currentLat,currentLng,bestPoint.lat,bestPoint.lng);

    for(const p of safePoints){
      const d = distanceKm(currentLat,currentLng,p.lat,p.lng);
      if(d<bestDist){bestDist=d;bestPoint=p;}
    }

    if(safeRouteLine){map.removeLayer(safeRouteLine);}
    safeRouteLine = L.polyline([[currentLat,currentLng],[bestPoint.lat,bestPoint.lng]],{
      color:"#007aff",weight:5
    }).addTo(map);

    L.circle([bestPoint.lat,bestPoint.lng],{radius:300,color:'#34c759',fillOpacity:0.3}).addTo(map);
    map.fitBounds(safeRouteLine.getBounds());

    setStatus("âš ï¸ OSRM lá»—i, Ä‘Ã£ váº½ Ä‘Æ°á»ng tháº³ng an toÃ n gáº§n nháº¥t.");
    document.getElementById("ai-result").innerText =
      "OSRM táº¡m khÃ´ng pháº£n há»“i â€” Ä‘Ã£ dÃ¹ng Ä‘Æ°á»ng tháº³ng gáº§n nháº¥t.";
    return;
  }

  const best = valid.reduce((a,b)=>a.dist<b.dist?a:b);
  if(safeRouteLine){map.removeLayer(safeRouteLine);}

  safeRouteLine = L.geoJSON(best.geo,{color:"#007aff",weight:5}).addTo(map);
  map.fitBounds(safeRouteLine.getBounds());
  L.circle([best.p.lat,best.p.lng],{radius:300,color:'#34c759',fillOpacity:0.3}).addTo(map);

  setStatus("âœ… ÄÆ°á»ng an toÃ n Ä‘Ã£ sáºµn sÃ ng");
  document.getElementById("ai-result").innerText =
    "AI Ä‘Ã£ chá»n tuyáº¿n an toÃ n nháº¥t theo OSRM.";
}

// ========== CLEAR MAP ==========
function clearFloodPath(){
  if(safeRouteLine){map.removeLayer(safeRouteLine);}
  floodArrows.forEach(a=>map.removeLayer(a));
  floodArrows=[];

  flowV2Layers.forEach(l=>map.removeLayer(l));
  flowV2Layers=[];
  if(flowV2FloodPolygon){map.removeLayer(flowV2FloodPolygon);flowV2FloodPolygon=null;}

  setStatus("ğŸ§¹ ÄÃ£ xÃ³a dá»¯ liá»‡u");
}

// ========== SIMULATE NGUY HIá»‚M (ÄÃƒ Gá»˜P BÃO Äá»˜NG) ==========
function simulateDanger(){
  if(!currentLat||!currentLng){
    alert("ChÆ°a cÃ³ vá»‹ trÃ­.");
    return;
  }

  // Váº½ vÃ¹ng nguy hiá»ƒm
  L.circle([currentLat,currentLng],{
      radius:800,
      color:"#ff0000",
      fillOpacity:0.3
  }).addTo(map).bindPopup("âš ï¸ Khu vá»±c nguy hiá»ƒm mÃ´ phá»ng").openPopup();

  setStatus("ğŸ›Ÿ MÃ´ phá»ng thá»i tiáº¿t cá»±c Ä‘oan.");

  // ===== BÃO Äá»˜NG Ã‚M THANH =====
  const sound = document.getElementById("alert-sound");
  try { sound.play().catch(()=>{}); } catch(e){}

  // ===== FLASH Cáº¢NH BÃO =====
  document.body.style.transition = "0s";
  let flashCount = 0;
  const flashInterval = setInterval(()=>{
    flashCount++;
    document.body.style.background =
      (flashCount % 2 == 0) ? "#ff000033" : "#ffffff";
    if(flashCount >= 12){
      clearInterval(flashInterval);
      document.body.style.background = "";
      document.body.style.transition = "0.3s";
    }
  }, 500);

  // ===== BANNER Cáº¢NH BÃO =====
  const alertDiv = document.createElement("div");
  alertDiv.id = "sim-alert-banner";
  alertDiv.style.position = "fixed";
  alertDiv.style.top = "20px";
  alertDiv.style.left = "50%";
  alertDiv.style.transform = "translateX(-50%)";
  alertDiv.style.padding = "14px 22px";
  alertDiv.style.borderRadius = "14px";
  alertDiv.style.background = "#ff0000";
  alertDiv.style.color = "#fff";
  alertDiv.style.fontSize = "18px";
  alertDiv.style.fontWeight = "700";
  alertDiv.style.zIndex = "99999";
  alertDiv.style.boxShadow = "0 4px 20px rgba(0,0,0,0.2)";
  alertDiv.innerText = "ğŸš¨ Cáº¢NH BÃO: MÃ” PHá»NG THá»œI TIáº¾T Cá»°C ÄOAN!";
  document.body.appendChild(alertDiv);

  setTimeout(()=>{
    const b = document.getElementById("sim-alert-banner");
    if(b) b.remove();
  },10000);

  // ===== AUTO CHáº Y FLOW AI V2 =====
  setTimeout(()=>{ runFlowAIV2(); }, 500);
}

// ========== LÆ¯U CÃ€I Äáº¶T ==========
function saveEvacSettings(){
  const threshold=document.getElementById("evac-threshold").value;
  localStorage.setItem("evac-threshold",threshold);
  alert("ÄÃ£ lÆ°u ngÆ°á»¡ng mÆ°a: "+threshold+" mm");
}
function setStatus(t){document.getElementById("status").innerText=t;}

// ========== DARK MODE ==========
function toggleDarkMode(){
  document.body.classList.toggle("dark");
  map.setZoom(map.getZoom());
}

// ========== EXPORT PDF ==========
async function exportPDF(){
  const { jsPDF } = window.jspdf;
  const canvas = await html2canvas(document.body);
  const pdf = new jsPDF("p","mm","a4");
  const imgData = canvas.toDataURL("image/png");
  const pdfWidth = pdf.internal.pageSize.getWidth();
  const pdfHeight = canvas.height * pdfWidth / canvas.width;
  pdf.addImage(imgData,"PNG",0,0,pdfWidth,pdfHeight);
  pdf.save("SafeRoute_Report.pdf");
  setStatus("ğŸ“„ ÄÃ£ xuáº¥t bÃ¡o cÃ¡o PDF");
}

// ========== UI MODE ==========
function toggleUIMode(){
  alert("Chá»©c nÄƒng chuyá»ƒn giao diá»‡n Ä‘ang nÃ¢ng cáº¥p.");
}

// ========== CHUYá»‚N TRANG ==========

function showPage(page){
  const p1 = document.getElementById("page1");
  const p2 = document.getElementById("page2");
  const p3 = document.getElementById("page3");

  if(page === 1){
    if(p1) p1.style.display = "block";
    if(p2) p2.style.display = "none";
    if(p3) p3.style.display = "none";
    setStatus("Sáºµn sÃ ng");
  } else if(page === 2){
    if(p1) p1.style.display = "none";
    if(p2) p2.style.display = "block";
    if(p3) p3.style.display = "none";
    setDamStatus("Sáºµn sÃ ng");

    if(currentLat && currentLng){
      userLat = currentLat;
      userLng = currentLng;
      localStorage.setItem("userLat", userLat);
      localStorage.setItem("userLng", userLng);
      const lb = document.getElementById("dam-location-label");
      if(lb) lb.innerText = `${userLat.toFixed(4)}, ${userLng.toFixed(4)}`;
    }

    if(!damMapInitialized){
      initDamMap();
      damMapInitialized = true;
      if(userLat && userLng) showNearbyDams();
    } else {
      if(mapDam && userLat && userLng){
        mapDam.setView([userLat, userLng], 11);
        mapDam.invalidateSize();
        showNearbyDams();
      }
    }
  } else if(page === 3){
    if(p1) p1.style.display = "none";
    if(p2) p2.style.display = "none";
    if(p3) p3.style.display = "block";
    setRescueStatus("Sáºµn sÃ ng");
    initOrUpdateRescueMap();
  }
}


function goToDamPage(){
  if(!currentLat || !currentLng){
    alert("Vui lÃ²ng chá»n vá»‹ trÃ­ trÆ°á»›c.");
    return;
  }
  showPage(2);
}
</script>

<!-- ==========================================
     ğŸŒŠ AI DÃ’NG CHáº¢Y V2 â€“ 8 hÆ°á»›ng + vÃ¹ng ngáº­p
     ========================================== -->
<script>
async function runFlowAIV2(){
  if(!currentLat || !currentLng){
    alert("ChÆ°a cÃ³ vá»‹ trÃ­!");
    return;
  }

  const resultEl = document.getElementById("flow-ai-v2-result");
  if(resultEl){
    resultEl.innerText = "ğŸ” Äang phÃ¢n tÃ­ch DEM vÃ  dÃ²ng cháº£y...";
  }

  flowV2Layers.forEach(l => map.removeLayer(l));
  flowV2Layers = [];
  if(flowV2FloodPolygon){
    map.removeLayer(flowV2FloodPolygon);
    flowV2FloodPolygon = null;
  }

  const dirs = [
    {name:"Báº¯c",      lat: 0.01,  lng: 0},
    {name:"ÄÃ´ng Báº¯c", lat: 0.007, lng: 0.007},
    {name:"ÄÃ´ng",     lat: 0,     lng: 0.01},
    {name:"ÄÃ´ng Nam", lat:-0.007, lng: 0.007},
    {name:"Nam",      lat:-0.01,  lng: 0},
    {name:"TÃ¢y Nam",  lat:-0.007, lng:-0.007},
    {name:"TÃ¢y",      lat: 0,     lng:-0.01},
    {name:"TÃ¢y Báº¯c",  lat: 0.007, lng:-0.007},
  ];

  const elevData = [];

  for(const d of dirs){
    const lat2 = currentLat + d.lat;
    const lng2 = currentLng + d.lng;
    try{
      const res = await fetch(
        `https://api.opentopodata.org/v1/srtm90m?locations=${lat2},${lng2}`
      );
      const data = await res.json();
      const elev = data.results?.[0]?.elevation ?? null;
      elevData.push({dir:d.name, elev, lat:lat2, lng:lng2});
    }catch(e){
      elevData.push({dir:d.name, elev:null, lat:lat2, lng:lng2});
    }
  }

  let centerElev = 0;
  try{
    const centerRes = await fetch(
      `https://api.opentopodata.org/v1/srtm90m?locations=${currentLat},${currentLng}`
    );
    const centerData = await centerRes.json();
    centerElev = centerData.results?.[0]?.elevation ?? 0;
  }catch(e){centerElev=0;}

  const validElev = elevData.filter(d => d.elev !== null);
  if(validElev.length === 0){
    resultEl.innerText = "KhÃ´ng láº¥y Ä‘Æ°á»£c DEM khu vá»±c";
    return;
  }

  let lowest = validElev[0];
  validElev.forEach(d=>{ if(d.elev < lowest.elev) lowest = d; });

  const slope = centerElev - lowest.elev;

  let flowScore = 0;
  if(slope > 50)      flowScore = 4;
  else if(slope > 30) flowScore = 3;
  else if(slope > 15) flowScore = 2;
  else if(slope > 5)  flowScore = 1;

  const floodPoints = [];
  validElev.forEach(d=>{
    const diff = centerElev - d.elev;
    if(diff >= 10){
      floodPoints.push(d);
      const c = L.circle([d.lat,d.lng],{
        radius:400,
        color:"#ff4444",
        fillOpacity:0.22
      }).addTo(map);
      flowV2Layers.push(c);
    }
  });

  const approxAreaKm2 = (floodPoints.length * 0.5).toFixed(2);

  if(floodPoints.length >= 3){
    const polyLatLngs = floodPoints.map(p => [p.lat,p.lng]);
    polyLatLngs.push([currentLat,currentLng]);
    flowV2FloodPolygon = L.polygon(polyLatLngs,{
      color:"#ff0000",
      weight:1,
      fillOpacity:0.08
    }).addTo(map);
  }

  const angle = getDirAngle(lowest.dir);

  const steps = 3;
  for(let i=1;i<=steps;i++){
    const factor = 0.004 * i;
    const latArrow = currentLat + (lowest.lat - currentLat)*factor/0.01;
    const lngArrow = currentLng + (lowest.lng - currentLng)*factor/0.01;

    const arrowIcon = L.divIcon({
      html: `<div class="arrow-anim" style="font-size:26px; transform: rotate(${angle}deg);">â¤</div>`,
      className:"",iconSize:[26,26],iconAnchor:[13,13]
    });

    const m = L.marker([latArrow,lngArrow],{icon:arrowIcon}).addTo(map);
    flowV2Layers.push(m);
  }

  const centerArrowIcon = L.divIcon({
    html:`<div class="arrow-anim" style="font-size:30px; transform: rotate(${angle}deg);">â¤</div>`,
    className:"",
    iconSize:[30,30],iconAnchor:[15,15]
  });

  const mainArrow = L.marker([currentLat,currentLng],{icon:centerArrowIcon})
    .addTo(map)
    .bindPopup(`HÆ°á»›ng nÆ°á»›c cháº£y chÃ­nh: ${lowest.dir}`).openPopup();
  flowV2Layers.push(mainArrow);

  let level = "ğŸŸ¢ Yáº¿u";
  if(flowScore >= 4)      level = "ğŸ”´ Cá»±c máº¡nh";
  else if(flowScore >= 3) level = "ğŸŸ  Máº¡nh";
  else if(flowScore >= 2) level = "ğŸŸ¡ Trung bÃ¬nh";

  resultEl.innerHTML = `
      ğŸ§­ <b>HÆ°á»›ng nÆ°á»›c cháº£y máº¡nh nháº¥t:</b> ${lowest.dir}<br>
      ğŸ” <b>Äá»™ cao táº¡i báº¡n:</b> ${centerElev.toFixed(1)} m<br>
      ğŸ“‰ <b>Äiá»ƒm tháº¥p nháº¥t:</b> ${lowest.elev.toFixed(1)} m<br>
      â›° <b>Äá»™ dá»‘c:</b> ${slope.toFixed(1)} m<br>
      ğŸŒŠ <b>Má»©c Ä‘á»™ dÃ²ng cháº£y:</b> ${level}<br>
      ğŸ“ <b>Diá»‡n tÃ­ch nguy cÆ¡:</b> ~ ${approxAreaKm2} kmÂ²<br>
  `;
}

function getDirAngle(dir){
  switch(dir){
    case "Báº¯c": return -90;
    case "ÄÃ´ng Báº¯c": return -45;
    case "ÄÃ´ng": return 0;
    case "ÄÃ´ng Nam": return 45;
    case "Nam": return 90;
    case "TÃ¢y Nam": return 135;
    case "TÃ¢y": return 180;
    case "TÃ¢y Báº¯c": return -135;
  }
  return 0;
}
</script>
<!-- ==========================================
     ğŸŒŠ TRA Cá»¨U Äáº¬P / Rá»¦I RO â€” PAGE 2
     ========================================== -->
<script>
let mapDam=null, radarLayerDam=null, damLayer=null;
let userLat=null, userLng=null;
let radiusDamKm=parseInt(localStorage.getItem("radiusDamKm")||10);
let damMapInitialized=false;

function setDamStatus(t){
  const el=document.getElementById("status-dam");
  if(el) el.innerText=t;
}

function setDamRadius(km){
  radiusDamKm=km;
  localStorage.setItem("radiusDamKm",km);

  const lb=document.getElementById("dam-radius-label");
  if(lb) lb.innerText=km;

  document.querySelectorAll(".dam-radius-btn").forEach(b=>{
    b.classList.toggle("active",parseInt(b.dataset.radius)==km);
  });

  if(mapDam && userLat && userLng) showNearbyDams();
}

function initDamMap(){
  mapDam=L.map("map-dam").setView([userLat||16, userLng||107], 9);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
    maxZoom:18,
    attribution:"Â© OpenStreetMap"
  }).addTo(mapDam);

  damLayer=L.layerGroup().addTo(mapDam);

  if(userLat && userLng){
    L.marker([userLat,userLng]).addTo(mapDam)
      .bindPopup("ğŸ“ Vá»‹ trÃ­ cá»§a báº¡n").openPopup();

    const lb=document.getElementById("dam-location-label");
    if(lb) lb.innerText=`${userLat.toFixed(4)}, ${userLng.toFixed(4)}`;
  }

  setDamRadius(radiusDamKm);
}

function toggleDamRadar(){
  if(!mapDam) return;

  if(radarLayerDam){
    mapDam.removeLayer(radarLayerDam);
    radarLayerDam=null;
    setDamStatus("ÄÃ£ áº©n radar");
  } else {
    radarLayerDam=L.tileLayer(
      "https://tilecache.rainviewer.com/v2/radar/nowcast/0/256/{z}/{x}/{y}/2/1_1.png",
      {opacity:0.55}
    );
    radarLayerDam.addTo(mapDam);
    setDamStatus("Hiá»ƒn thá»‹ radar mÆ°a");
  }
}

// ============================
// ğŸŒ FETCH DATASET GEO-DAR / GDAT + FALLBACK
// ============================
async function fetchDamsData(){
  setDamStatus("Äang táº£i dá»¯ liá»‡u Ä‘áº­p...");

  const fallbackDams = [
    {name:"Há»“ Káº» Gá»—",lat:18.311,lng:105.85,height:50,volume:345,year:1999,type:"Há»“ chá»©a"},
    {name:"Há»“ SÃ´ng TrÃ­",lat:18.35,lng:106.05,height:35,volume:120,year:2004,type:"Thá»§y Ä‘iá»‡n"},
    {name:"Há»“ Báº£n Váº½",lat:19.0,lng:104.88,height:135,volume:1900,year:2010,type:"Thá»§y Ä‘iá»‡n"},
    {name:"Há»“ Cá»­a Äáº¡t",lat:19.73,lng:105.33,height:119,volume:1500,year:2012,type:"Thá»§y lá»£i - Thá»§y Ä‘iá»‡n"}
  ];

  try{
    const res = await fetch("https://storage.googleapis.com/gdams-public/gdams_vietnam.json", {cache:"no-store"});
    if(!res.ok) throw new Error("KhÃ´ng táº£i Ä‘Æ°á»£c tá»« GDAT");

    const data = await res.json();
    setDamStatus(`ÄÃ£ táº£i ${data.length} Ä‘áº­p tá»« GDAT`);
    return data;
  }catch(e){
    console.warn("GDAT lá»—i â€” dÃ¹ng fallback.");
    setDamStatus("DÃ¹ng dá»¯ liá»‡u Ä‘áº­p dá»± phÃ²ng (offline)");
    return fallbackDams;
  }
}

// ============================
// ğŸ“ Haversine khoáº£ng cÃ¡ch
// ============================
function distanceKm(lat1,lon1,lat2,lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

// ============================
// ğŸ—º HIá»‚N THá»Š Äáº¬P TRONG BÃN KÃNH
// ============================
async function showNearbyDams(){
  if(!damLayer) return;
  damLayer.clearLayers();

  const dams = await fetchDamsData();
  if(!userLat || !userLng){
    setDamStatus("ChÆ°a cÃ³ tá»a Ä‘á»™ ngÆ°á»i dÃ¹ng");
    return;
  }

  const nearby = dams
    .filter(d=>distanceKm(userLat,userLng,d.lat,d.lng) <= radiusDamKm)
    .map(d=>({...d, distance:distanceKm(userLat,userLng,d.lat,d.lng)}))
    .sort((a,b)=>a.distance - b.distance);

  if(!nearby.length){
    document.getElementById("dam-list").innerHTML = "<i>KhÃ´ng cÃ³ Ä‘áº­p nÃ o trong bÃ¡n kÃ­nh.</i>";
    setDamStatus("KhÃ´ng cÃ³ Ä‘áº­p gáº§n");
    return;
  }

  let html = "";
  nearby.forEach(d=>{
    html += `
      <div style="margin-bottom:6px;padding:6px 10px;border-left:4px solid #007aff;background:#f6f8ff;border-radius:8px;">
        <b>${d.name || "Äáº­p khÃ´ng tÃªn"}</b><br>
        ğŸ“ CÃ¡ch: ${d.distance.toFixed(1)} km<br>
        ğŸ” Cao: ${d.height || '--'} m Â· ğŸ’§ Dung tÃ­ch: ${d.volume || '--'} triá»‡u mÂ³<br>
        ğŸ— NÄƒm: ${d.year || 'KhÃ´ng rÃµ'}<br>
        âš™ï¸ Loáº¡i: ${d.type || 'KhÃ´ng xÃ¡c Ä‘á»‹nh'}
      </div>
    `;

    const icon = L.divIcon({
      html:`<div style="font-size:18px;">ğŸ’§</div>`,
      className:"",
      iconSize:[20,20],
      iconAnchor:[10,10]
    });

    L.marker([d.lat,d.lng],{icon})
      .addTo(damLayer)
      .bindPopup(`<b>${d.name}</b><br>${d.distance.toFixed(1)} km`);
  });

  document.getElementById("dam-list").innerHTML = html;

  L.circle([userLat,userLng],{
    radius:radiusDamKm*1000,
    color:'#007aff',
    fillOpacity:0.08
  }).addTo(damLayer);

  setDamStatus(`TÃ¬m tháº¥y ${nearby.length} Ä‘áº­p`);
}

// ============================
// ğŸŒ§ GET RAIN
// ============================
async function getCurrentRain(lat,lng){
  try{
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&hourly=rain,precipitation&forecast_days=1&timezone=auto`;
    const res = await fetch(url);
    const data = await res.json();
    const rain = data.hourly?.rain?.slice(-1)[0] || 0;
    document.getElementById("dam-rain-label").innerText = rain;
    return rain;
  }catch(e){
    document.getElementById("dam-rain-label").innerText = "Lá»—i";
    return 0;
  }
}

// ============================
// ğŸ” DEM ELEVATION (OFFLINE Æ¯U TIÃŠN DEM HÃ€ TÄ¨NH + 150KM)
// ============================

// DEM offline toÃ n tá»‰nh HÃ  TÄ©nh (chi tiáº¿t) & vÃ¹ng bÃ¡n kÃ­nh 150km (rá»™ng)
let demHatinh = {};
let demHatinh150 = {};
let demReady = false;

// Táº£i DEM offline tá»« thÆ° má»¥c ./dem (hÃ£y Ä‘áº£m báº£o Ä‘Ã£ upload Ä‘Ãºng 2 file JSON)
async function loadOfflineDEM(){
  try{
    const r1 = await fetch("./dem/hatinh_30m_0p001.json");
    demHatinh = await r1.json();
    console.log("âœ… DEM HÃ  TÄ©nh 30m loaded:", Object.keys(demHatinh).length, "Ä‘iá»ƒm");
  }catch(e){
    console.error("Lá»—i load DEM HÃ  TÄ©nh:", e);
  }

  try{
    const r2 = await fetch("./dem/hatinh_150km_0p003.json");
    demHatinh150 = await r2.json();
    console.log("âœ… DEM 150km loaded:", Object.keys(demHatinh150).length, "Ä‘iá»ƒm");
  }catch(e){
    console.error("Lá»—i load DEM 150km:", e);
  }
  demReady = true;
}

// Láº¥y Ä‘á»™ cao tá»« DEM offline (tráº£ vá» null náº¿u khÃ´ng cÃ³)
function getElevationFromDEM(lat,lng){
  const key = lat.toFixed(3) + "," + lng.toFixed(3);

  if(demHatinh && demHatinh[key] !== undefined){
    return demHatinh[key];
  }
  if(demHatinh150 && demHatinh150[key] !== undefined){
    return demHatinh150[key];
  }
  return null;
}

// HÃ m láº¥y Ä‘á»™ cao Æ°u tiÃªn DEM offline, náº¿u khÃ´ng cÃ³ má»›i fallback sang API (náº¿u cáº§n)
async function getElevation(lat,lng){
  try{
    let elev = null;

    // 1) Æ¯u tiÃªn DEM offline
    if(demReady){
      elev = getElevationFromDEM(lat,lng);
    }

    // 2) Náº¿u DEM chÆ°a cÃ³ hoáº·c ngoÃ i vÃ¹ng DEM â†’ cÃ³ thá»ƒ fallback online
    if(elev === null){
      // Náº¿u báº¡n muá»‘n dÃ¹ng hoÃ n toÃ n offline, cÃ³ thá»ƒ bá» háº³n Ä‘oáº¡n fetch dÆ°á»›i:
      const res = await fetch(`https://api.opentopodata.org/v1/srtm90m?locations=${lat},${lng}`);
      const data = await res.json();
      elev = data.results?.[0]?.elevation ?? 0;
    }

    const lbl = document.getElementById("dam-elev-label");
    if(lbl) lbl.innerText = elev.toFixed(1);
    return elev;
  }catch(e){
    const lbl = document.getElementById("dam-elev-label");
    if(lbl) lbl.innerText = "--";
    console.error("Lá»—i getElevation:", e);
    return 0;
  }
}

// ============================
// ğŸ§  PHÃ‚N TÃCH Rá»¦I RO
// ============================
async function analyzeRiskAuto(){
  if(!userLat || !userLng){
    alert("HÃ£y chá»n vá»‹ trÃ­ á»Ÿ trang 1 trÆ°á»›c.");
    return;
  }

  setDamStatus("AI Ä‘ang phÃ¢n tÃ­ch...");

  const dams = await fetchDamsData();
  const nearby = dams.filter(d=>distanceKm(userLat,userLng,d.lat,d.lng)<=radiusDamKm);
  const rain = await getCurrentRain(userLat,userLng);
  const elev = await getElevation(userLat,userLng);
  const sound = document.getElementById("alert-sound");

  let riskLevel = "ğŸŸ¢ An toÃ n";
  let color = "#28a745";

  if(rain > 120 && elev < 40 && nearby.length>=1){
    riskLevel = "ğŸš¨ Nguy cÆ¡ cao (mÆ°a cá»±c lá»›n + Ä‘á»‹a hÃ¬nh tháº¥p + gáº§n Ä‘áº­p)";
    color = "#d32f2f";
    sound.play();
  }
  else if(rain > 80 && elev < 60){
    riskLevel = "ğŸŸ  Nguy cÆ¡ trung bÃ¬nh (mÆ°a lá»›n + Ä‘á»‹a hÃ¬nh tháº¥p)";
    color = "#f39c12";
  }
  else if(rain > 40 && nearby.length>=2){
    riskLevel = "ğŸŸ¡ Theo dÃµi (mÆ°a nhiá»u + nhiá»u Ä‘áº­p gáº§n)";
    color = "#ffb300";
  }

  const label = document.getElementById("dam-risk-label");
  label.innerText = riskLevel;
  label.style.color = color;

  setDamStatus("PhÃ¢n tÃ­ch hoÃ n táº¥t");
}
</script>


<!-- ========================
     SOS MODAL
     ======================== -->
<div id="sos-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:9999;align-items:center;justify-content:center;">
  <div style="background:#ffffff;border-radius:18px;padding:18px;max-width:380px;width:92%;box-shadow:0 10px 30px rgba(0,0,0,0.35);">
    <h3>ğŸš¨ Gá»­i tÃ­n hiá»‡u SOS</h3>
    <p class="small">ThÃ´ng tin nÃ y Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ há»— trá»£ lá»±c lÆ°á»£ng cá»©u há»™ khi cÃ³ thiÃªn tai (mÃ´ phá»ng trong phiÃªn báº£n thá»­ nghiá»‡m).</p>

    <label class="small">Há» vÃ  tÃªn:</label>
    <input id="sos-name" placeholder="VD: Nguyá»…n VÄƒn A" style="width:100%;margin:4px 0 8px 0;padding:8px 10px;border-radius:10px;border:1px solid #cfd7e4;">

    <label class="small">Sá»‘ Ä‘iá»‡n thoáº¡i:</label>
    <input id="sos-phone" placeholder="VD: 09xx..." style="width:100%;margin:4px 0 8px 0;padding:8px 10px;border-radius:10px;border:1px solid #cfd7e4;">

    <label class="small">Má»©c Ä‘á»™:</label>
    <select id="sos-level" style="width:100%;margin:4px 0 8px 0;padding:8px 10px;border-radius:10px;border:1px solid #cfd7e4;">
      <option value="high">ğŸš¨ Nguy hiá»ƒm cao</option>
      <option value="medium">âš ï¸ Cáº§n há»— trá»£</option>
      <option value="low">âœ… An toÃ n, cáº§n theo dÃµi</option>
    </select>

    <label class="small">Ghi chÃº (tuá»³ chá»n):</label>
    <textarea id="sos-note" rows="2" placeholder="VD: NhÃ  em Ä‘ang bá»‹ ngáº­p, cÃ³ ngÆ°á»i giÃ ..." style="width:100%;margin:4px 0 8px 0;padding:8px 10px;border-radius:10px;border:1px solid #cfd7e4;resize:vertical;"></textarea>

    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px;">
      <button class="gray" onclick="closeSOSForm()">Há»§y</button>
      <button class="danger" onclick="submitSOS()">Gá»­i SOS</button>
    </div>
  </div>
</div>



<script>
// ==========================================
// ğŸ†˜ RESCUE HUB â€” Báº¢N Äá»’ Cá»¨U Há»˜ & SOS
// ==========================================

let sosReports = [];
let mapRescue = null;
let sosLayer = null;

// Äá»c / ghi SOS vÃ o localStorage
function loadSOSFromStorage(){
  try{
    const raw = localStorage.getItem("sosReports");
    sosReports = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(sosReports)) sosReports = [];
  }catch(e){
    sosReports = [];
  }
}

function saveSOSToStorage(){
  try{
    localStorage.setItem("sosReports", JSON.stringify(sosReports));
  }catch(e){}
}

function setRescueStatus(t){
  const el = document.getElementById("status-rescue");
  if(el) el.innerText = t;
}

// Má»Ÿ / Ä‘Ã³ng modal SOS
function openSOSForm(){
  if(!currentLat || !currentLng){
    alert("Vui lÃ²ng chá»n vá»‹ trÃ­ (GPS hoáº·c nháº­p tá»a Ä‘á»™) trÆ°á»›c khi gá»­i SOS.");
    return;
  }
  const modal = document.getElementById("sos-modal");
  if(!modal) return;

  // gá»£i Ã½ tÃªn / sÄ‘t tá»« localStorage (náº¿u cÃ³)
  try{
    const profileRaw = localStorage.getItem("userProfile");
    if(profileRaw){
      const p = JSON.parse(profileRaw);
      if(p.name) document.getElementById("sos-name").value = p.name;
      if(p.phone) document.getElementById("sos-phone").value = p.phone;
    }
  }catch(e){}

  modal.style.display = "flex";
}

function closeSOSForm(){
  const modal = document.getElementById("sos-modal");
  if(modal) modal.style.display = "none";
}

function submitSOS(){
  const nameEl = document.getElementById("sos-name");
  const phoneEl = document.getElementById("sos-phone");
  const levelEl = document.getElementById("sos-level");
  const noteEl = document.getElementById("sos-note");

  const name = nameEl.value.trim();
  const phone = phoneEl.value.trim();
  const level = levelEl.value;
  const note = noteEl.value.trim();

  if(!name || !phone){
    alert("Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ há» tÃªn vÃ  sá»‘ Ä‘iá»‡n thoáº¡i.");
    return;
  }
  if(!currentLat || !currentLng){
    alert("ChÆ°a cÃ³ vá»‹ trÃ­ hiá»‡n táº¡i. HÃ£y báº­t GPS hoáº·c nháº­p tá»a Ä‘á»™ rá»“i báº¥m Hiá»ƒn thá»‹.");
    return;
  }

  // LÆ°u há»“ sÆ¡ cÆ¡ báº£n Ä‘á»ƒ láº§n sau gá»£i Ã½
  try{
    localStorage.setItem("userProfile", JSON.stringify({name, phone}));
  }catch(e){}

  const report = {
    id: Date.now(),
    name,
    phone,
    level,
    note,
    lat: currentLat,
    lng: currentLng,
    time: new Date().toISOString()
  };

  loadSOSFromStorage();
  sosReports.push(report);
  saveSOSToStorage();

  // Cáº­p nháº­t map & danh sÃ¡ch náº¿u Ä‘ang á»Ÿ trang 3
  renderSOSOnMap();
  renderSOSList();

  closeSOSForm();
  alert("ÄÃ£ gá»­i tÃ­n hiá»‡u SOS (mÃ´ phá»ng). Trong triá»ƒn khai tháº­t, dá»¯ liá»‡u nÃ y sáº½ gá»­i tá»›i trung tÃ¢m cá»©u há»™.");
}

// Khá»Ÿi táº¡o map Rescue
function initOrUpdateRescueMap(){
  loadSOSFromStorage();

  const targetLat = currentLat || parseFloat(localStorage.getItem("userLat")) || 18.3;
  const targetLng = currentLng || parseFloat(localStorage.getItem("userLng")) || 105.7;

  if(!mapRescue){
    mapRescue = L.map("map-rescue").setView([targetLat, targetLng], 11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
      maxZoom: 18,
      attribution: "Â© OpenStreetMap"
    }).addTo(mapRescue);
    sosLayer = L.layerGroup().addTo(mapRescue);
  } else {
    mapRescue.setView([targetLat, targetLng], 11);
    mapRescue.invalidateSize();
  }

  renderSOSOnMap();
  renderSOSList();
}

// Render marker lÃªn báº£n Ä‘á»“
function renderSOSOnMap(){
  if(!mapRescue || !sosLayer) return;

  sosLayer.clearLayers();

  sosReports.forEach(r => {
    const icon = L.divIcon({
      html: `<div style="font-size:18px;">${
        r.level === "high" ? "ğŸŸ¥" : (r.level === "medium" ? "ğŸŸ§" : "ğŸŸ©")
      }</div>`,
      className: "",
      iconSize:[20,20],
      iconAnchor:[10,10]
    });

    L.marker([r.lat, r.lng], {icon})
      .addTo(sosLayer)
      .bindPopup(
        `<b>${r.name}</b><br>` +
        `ğŸ“± ${r.phone}<br>` +
        `ğŸ“ ${r.lat.toFixed(4)}, ${r.lng.toFixed(4)}<br>` +
        `â± ${new Date(r.time).toLocaleString("vi-VN")}<br>` +
        (r.note ? `ğŸ“ ${r.note}` : "")
      );
  });

  setRescueStatus(`Hiá»ƒn thá»‹ ${sosReports.length} tÃ­n hiá»‡u SOS (mÃ´ phá»ng).`);
}

// Render danh sÃ¡ch SOS
function renderSOSList(){
  const wrap = document.getElementById("sos-list");
  if(!wrap) return;

  if(!sosReports.length){
    wrap.innerHTML = "<i>ChÆ°a cÃ³ tÃ­n hiá»‡u SOS nÃ o.</i>";
    return;
  }

  let html = "";
  const sorted = [...sosReports].sort((a,b) => b.id - a.id);
  sorted.forEach(r => {
    let label =
      r.level === "high" ? "ğŸš¨ Nguy hiá»ƒm cao" :
      r.level === "medium" ? "âš ï¸ Cáº§n há»— trá»£" : "âœ… An toÃ n / theo dÃµi";

    html += `
      <div style="margin-bottom:8px;padding:8px 10px;border-radius:10px;border-left:4px solid ${
        r.level === "high" ? "#e53935" : (r.level === "medium" ? "#fb8c00" : "#43a047")
      };background:#f7f9ff;">
        <b>${r.name}</b> Â· <span style="font-size:13px;">${label}</span><br>
        ğŸ“± ${r.phone}<br>
        ğŸ“ ${r.lat.toFixed(4)}, ${r.lng.toFixed(4)}<br>
        â± ${new Date(r.time).toLocaleString("vi-VN")}<br>
        ${r.note ? ("ğŸ“ " + r.note) : ""}
      </div>
    `;
  });

  wrap.innerHTML = html;
}

// NÃºt refresh trÃªn trang Rescue Hub
function refreshSOSData(){
  loadSOSFromStorage();
  renderSOSOnMap();
  renderSOSList();
  setRescueStatus("ÄÃ£ cáº­p nháº­t tá»« bá»™ nhá»› cá»¥c bá»™.");
}

// Tá»± load SOS khi trang báº¯t Ä‘áº§u
document.addEventListener("DOMContentLoaded", function(){
  loadSOSFromStorage();
  loadOfflineDEM();
});

// ==========================================
// â± FLOOD TIMELINE 4D PRO
// ==========================================

let floodTimelineFrames = [];
let floodTimelineTimer = null;
let floodTimelineIndex = 0;

function clearFloodTimelineLayers(){
  if(!floodTimelineFrames.length) return;
  floodTimelineFrames.forEach(frame=>{
    frame.forEach(layer=>{
      if(map.hasLayer(layer)) map.removeLayer(layer);
    });
  });
  floodTimelineFrames = [];
}

async function startFloodTimeline(){
  if(!currentLat || !currentLng){
    alert("ChÆ°a cÃ³ vá»‹ trÃ­. HÃ£y chá»n GPS hoáº·c nháº­p tá»a Ä‘á»™ trÆ°á»›c.");
    return;
  }

  // dá»«ng phiÃªn cÅ© náº¿u cÃ³
  stopFloodTimeline();
  clearFloodTimelineLayers();

  const label = document.getElementById("flood-timeline-label");
  const stepLabel = document.getElementById("flood-timeline-step");
  if(label) label.innerText = "Äang tÃ­nh toÃ¡n DEM vÃ  mÃ´ phá»ng lan nÆ°á»›c...";
  if(stepLabel) stepLabel.innerText = "-";

  // Láº¥y DEM táº¡i tÃ¢m vÃ  8 hÆ°á»›ng (giá»‘ng Flow V2 nhÆ°ng bÆ°á»›c lá»›n hÆ¡n)
  const dirs = [
    {name:"Báº¯c",      lat: 0.02,  lng: 0},
    {name:"ÄÃ´ng Báº¯c", lat: 0.014, lng: 0.014},
    {name:"ÄÃ´ng",     lat: 0,     lng: 0.02},
    {name:"ÄÃ´ng Nam", lat:-0.014, lng: 0.014},
    {name:"Nam",      lat:-0.02,  lng: 0},
    {name:"TÃ¢y Nam",  lat:-0.014, lng:-0.014},
    {name:"TÃ¢y",      lat: 0,     lng:-0.02},
    {name:"TÃ¢y Báº¯c",  lat: 0.014, lng:-0.014},
  ];

  let centerElev = 0;
  try{
    const resC = await fetch(`https://api.opentopodata.org/v1/srtm90m?locations=${currentLat},${currentLng}`);
    const dataC = await resC.json();
    centerElev = dataC.results?.[0]?.elevation ?? 0;
  }catch(e){ centerElev = 0; }

  const samples = [];
  for(const d of dirs){
    const lat2 = currentLat + d.lat;
    const lng2 = currentLng + d.lng;
    try{
      const res = await fetch(`https://api.opentopodata.org/v1/srtm90m?locations=${lat2},${lng2}`);
      const data = await res.json();
      const elev = data.results?.[0]?.elevation ?? null;
      if(elev !== null){
        samples.push({dir:d.name, lat:lat2, lng:lng2, elev});
      }
    }catch(e){}
  }

  if(!samples.length){
    if(label) label.innerText = "KhÃ´ng láº¥y Ä‘Æ°á»£c DEM Ä‘á»ƒ mÃ´ phá»ng.";
    return;
  }

  // XÃ¡c Ä‘á»‹nh cÃ¡c hÆ°á»›ng nÆ°á»›c cÃ³ xu hÆ°á»›ng cháº£y tá»›i (tháº¥p hÆ¡n tÃ¢m)
  const flows = samples
    .filter(s => s.elev < centerElev)
    .map(s => ({
      ...s,
      slope: centerElev - s.elev
    }))
    .sort((a,b)=> b.slope - a.slope);

  if(!flows.length){
    if(label) label.innerText = "Äá»‹a hÃ¬nh cao, nguy cÆ¡ lan nÆ°á»›c tháº¥p (khÃ´ng cÃ³ hÆ°á»›ng tháº¥p hÆ¡n rÃµ rá»‡t).";
    return;
  }

  // Táº¡o 6 má»‘c thá»i gian: 0, 10, 20, 30, 45, 60 phÃºt
  const timelineMinutes = [0,10,20,30,45,60];
  floodTimelineFrames = [];
  const baseRadius = 300; // mÃ©t

  timelineMinutes.forEach((min, idxStep)=>{
    const frameLayers = [];

    // Ä‘Æ°á»ng trÃ²n lan nÆ°á»›c chung quanh tÃ¢m
    const rCommon = baseRadius + min * 20;
    const circle = L.circle([currentLat, currentLng],{
      radius: rCommon,
      color: "#2196f3",
      fillOpacity: 0.04,
      weight: 1
    }).addTo(map);
    frameLayers.push(circle);

    // cÃ¡c "cÃ¡nh" lan máº¡nh theo nhá»¯ng hÆ°á»›ng dá»‘c lá»›n
    flows.forEach((f, i)=>{
      const weight = 1 + (f.slope / 20); // slope cÃ ng lá»›n nÆ°á»›c lan cÃ ng nhanh
      const extra = min * 30 * weight;
      const rDir = baseRadius/2 + extra;

      const latMid = (currentLat + f.lat)/2;
      const lngMid = (currentLng + f.lng)/2;

      const cDir = L.circle([latMid, lngMid],{
        radius: rDir,
        color: i === 0 ? "#1565c0" : "#42a5f5",
        fillOpacity: 0.15,
        weight: 1
      }).addTo(map);
      frameLayers.push(cDir);
    });

    floodTimelineFrames.push(frameLayers);
  });

  // Báº¯t Ä‘áº§u play
  floodTimelineIndex = 0;
  if(label) label.innerText = "Äang mÃ´ phá»ng lan nÆ°á»›c...";
  playFloodTimelineStep();

  floodTimelineTimer = setInterval(()=>{
    floodTimelineIndex = (floodTimelineIndex + 1) % floodTimelineFrames.length;
    playFloodTimelineStep();
  }, 1800);
}

function playFloodTimelineStep(){
  if(!floodTimelineFrames.length) return;

  // áº¨n táº¥t cáº£ frame
  floodTimelineFrames.forEach((frame, i)=>{
    frame.forEach(layer=>{
      if(i === floodTimelineIndex){
        if(!map.hasLayer(layer)) map.addLayer(layer);
      } else {
        if(map.hasLayer(layer)) map.removeLayer(layer);
      }
    });
  });

  const label = document.getElementById("flood-timeline-label");
  const stepLabel = document.getElementById("flood-timeline-step");
  const timelineMinutes = [0,10,20,30,45,60];

  if(label){
    label.innerText = `Khung mÃ´ phá»ng phÃºt thá»© ${timelineMinutes[floodTimelineIndex]} (Æ°á»›c tÃ­nh).`;
  }
  if(stepLabel){
    stepLabel.innerText = `${timelineMinutes[floodTimelineIndex]} phÃºt`;
  }
}

function stopFloodTimeline(){
  if(floodTimelineTimer){
    clearInterval(floodTimelineTimer);
    floodTimelineTimer = null;
  }
  clearFloodTimelineLayers();
  const label = document.getElementById("flood-timeline-label");
  const stepLabel = document.getElementById("flood-timeline-step");
  if(label) label.innerText = "ÄÃ£ dá»«ng mÃ´ phá»ng.";
  if(stepLabel) stepLabel.innerText = "-";
}

// ==========================================
// ğŸ§  SAFEROUTE PRO V3 â€” ÄÃNH GIÃ NHIá»€U TUYáº¾N
// ==========================================

async function computeSafeRouteProV3(){
  if(!currentLat || !currentLng){
    alert("ChÆ°a cÃ³ vá»‹ trÃ­. HÃ£y chá»n tá»a Ä‘á»™ trÆ°á»›c.");
    return;
  }

  setStatus("ğŸ§  AI Ä‘ang tÃ­nh toÃ¡n 3 tuyáº¿n Ä‘Æ°á»ng...");

  // táº¡o 3 Ä‘iá»ƒm Ä‘Ã­ch theo 3 hÆ°á»›ng khÃ¡c nhau trong bÃ¡n kÃ­nh radiusKm
  const R = radiusKm / 111; // ~ Ä‘á»™
  const targets = [
    {name:"ÄÃ­ch A (Báº¯c)", lat: currentLat + R, lng: currentLng},
    {name:"ÄÃ­ch B (ÄÃ´ng)", lat: currentLat, lng: currentLng + R},
    {name:"ÄÃ­ch C (TÃ¢y)", lat: currentLat, lng: currentLng - R}
  ];

  const routes = [];
  for(const t of targets){
    try{
      const url = `https://router.project-osrm.org/route/v1/driving/${currentLng},${currentLat};${t.lng},${t.lat}?overview=full&geometries=geojson`;
      const res = await fetch(url);
      const data = await res.json();
      if(data.routes && data.routes[0]){
        routes.push({
          target: t,
          osrm: data.routes[0]
        });
      }
    }catch(e){}
  }

  if(!routes.length){
    setStatus("âš ï¸ KhÃ´ng láº¥y Ä‘Æ°á»£c dá»¯ liá»‡u OSRM. Thá»­ láº¡i sau.");
    return;
  }

  // XoÃ¡ tuyáº¿n cÅ© trÃªn báº£n Ä‘á»“ (náº¿u cÃ³)
  if(safeRouteLine){
    map.removeLayer(safeRouteLine);
    safeRouteLine = null;
  }

  // ÄÃ¡nh giÃ¡ tá»«ng tuyáº¿n: Ä‘á»™ cao, chiá»u dÃ i Æ°á»›c tÃ­nh rá»§i ro
  const scored = [];
  for(const r of routes){
    const coords = r.osrm.geometry.coordinates; // [lng,lat]
    const lengthM = r.osrm.distance || 0;

    // máº«u DEM: láº¥y 5 Ä‘iá»ƒm cÃ¡ch Ä‘á»u trÃªn tuyáº¿n
    const sampleIdx = [];
    const n = coords.length;
    const samplesCount = Math.min(5, n);
    for(let i=0;i<samplesCount;i++){
      sampleIdx.push(Math.floor(i*(n-1)/(samplesCount-1)));
    }

    let elevSum = 0;
    let elevMin = Infinity;
    let elevCount = 0;

    for(const idxPt of sampleIdx){
      const [lng, lat] = coords[idxPt];
      try{
        const res = await fetch(`https://api.opentopodata.org/v1/srtm90m?locations=${lat},${lng}`);
        const data = await res.json();
        const elev = data.results?.[0]?.elevation ?? null;
        if(elev !== null){
          elevSum += elev;
          elevMin = Math.min(elevMin, elev);
          elevCount++;
        }
      }catch(e){}
    }

    const elevAvg = elevCount ? elevSum / elevCount : 0;

    // Cháº¥m Ä‘iá»ƒm
    let scoreHeight = 0;
    if(elevAvg >= 80) scoreHeight = 40;
    else if(elevAvg >= 60) scoreHeight = 32;
    else if(elevAvg >= 40) scoreHeight = 24;
    else if(elevAvg >= 20) scoreHeight = 15;
    else scoreHeight = 8;

    // Ä‘iá»ƒm chiá»u dÃ i: ngáº¯n hÆ¡n thÃ¬ Ä‘iá»ƒm cao hÆ¡n
    let scoreLength = 0;
    const lengthKm = lengthM / 1000;
    if(lengthKm <= radiusKm * 1.2) scoreLength = 20;
    else if(lengthKm <= radiusKm * 1.6) scoreLength = 12;
    else scoreLength = 6;

    // táº¡m thá»i giáº£ láº­p "trÃ¡nh ngáº­p & sÃ´ng" báº±ng cÃ¡ch Æ°u tiÃªn tuyáº¿n cÃ³ Ä‘á»™ cao tá»‘i thiá»ƒu tá»‘t
    let scoreFlood = 0;
    if(elevMin >= 60) scoreFlood = 25;
    else if(elevMin >= 40) scoreFlood = 18;
    else if(elevMin >= 20) scoreFlood = 10;
    else scoreFlood = 4;

    // Ä‘iá»ƒm tá»•ng
    const totalScore = scoreHeight + scoreLength + scoreFlood;

    scored.push({
      route: r,
      elevAvg,
      elevMin: elevMin === Infinity ? 0 : elevMin,
      lengthKm,
      scoreHeight,
      scoreLength,
      scoreFlood,
      totalScore
    });
  }

  if(!scored.length){
    setStatus("âš ï¸ KhÃ´ng tÃ­nh Ä‘Æ°á»£c Ä‘iá»ƒm an toÃ n tuyáº¿n Ä‘Æ°á»ng.");
    return;
  }

  scored.sort((a,b)=> b.totalScore - a.totalScore);
  const best = scored[0];

  // Váº½ cáº£ 3 tuyáº¿n, tuyáº¿n tá»‘t nháº¥t tÃ´ Ä‘áº­m
  scored.forEach((s, idx)=>{
    const color = idx === 0 ? "#007aff" : "#90caf9";
    const weight = idx === 0 ? 6 : 3;
    const line = L.geoJSON(s.route.osrm.geometry, {color, weight}).addTo(map);
    if(idx === 0){
      safeRouteLine = line;
      map.fitBounds(line.getBounds());
    }
  });

  // Gá»­i káº¿t quáº£ ra há»™p AI
  const aiBox = document.getElementById("ai-result");
  if(aiBox){
    let html = "ğŸ§  <b>Káº¿t quáº£ SafeRoute Pro V3 (3 tuyáº¿n):</b><br>";
    scored.forEach((s, idx)=>{
      html += `â€¢ ${s.route.target.name}: `
           + `Äiá»ƒm tá»•ng <b>${s.totalScore.toFixed(1)}</b> `
           + `(cao TB: ${s.elevAvg.toFixed(1)} m, tháº¥p nháº¥t: ${s.elevMin.toFixed(1)} m, `
           + `chiá»u dÃ i: ${s.lengthKm.toFixed(2)} km)<br>`;
    });
    html += `<br>ğŸ‘‰ AI chá»n: <b>${best.route.target.name}</b> lÃ  tuyáº¿n an toÃ n nháº¥t.`;
    aiBox.innerHTML = html;
  }

  setStatus("âœ… SafeRoute Pro V3 Ä‘Ã£ chá»n tuyáº¿n Ä‘Æ°á»ng an toÃ n nháº¥t (mÃ´ phá»ng).");
}
</script>
</body>

</html>
