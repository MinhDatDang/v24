<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>SafeRoute AI ‚Äì Dashboard Th·ªùi ti·∫øt & Thi√™n tai</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#f3f5fb;
  --bg-card:#ffffff;
  --bg-box:#f5f7ff;
  --text:#111827;
  --text-muted:#6b7280;
  --primary:#0051b5;
  --primary-soft:#e0e7ff;
  --border-soft:#d1d5db;
  --shadow-soft:0 2px 8px rgba(0,0,0,0.08);
}
body.dark{
  --bg:#020617;
  --bg-card:#020617;
  --bg-box:#0b1120;
  --text:#e5e7eb;
  --text-muted:#9ca3af;
  --primary:#38bdf8;
  --primary-soft:#082f49;
  --border-soft:#1f2937;
  --shadow-soft:0 2px 12px rgba(0,0,0,0.6);
}
*{box-sizing:border-box;}
body{
  margin:0;font-family:'Segoe UI',system-ui,sans-serif;
  background:var(--bg);color:var(--text);
}

/* TOPBAR */
.topbar{
  background:var(--primary);color:#fff;
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 16px;position:sticky;top:0;z-index:20;
  box-shadow:0 2px 10px rgba(0,0,0,0.35);
}
.brand{
  font-size:20px;font-weight:700;
}
.brand span{
  font-size:12px;opacity:.9;margin-left:6px;
}
.top-actions{display:flex;gap:8px;align-items:center;}
.btn-chip{
  border-radius:999px;border:1px solid rgba(255,255,255,0.4);
  padding:4px 10px;font-size:13px;background:rgba(15,23,42,0.2);
  color:#fff;cursor:pointer;
}
.btn-chip:hover{background:rgba(15,23,42,0.35);}

/* LAYOUT */
.layout{
  max-width:1240px;margin:14px auto;
  display:grid;grid-template-columns:300px minmax(0,1fr);
  gap:16px;padding:0 12px;
}
@media(max-width:900px){
  .layout{grid-template-columns:1fr;}
}

/* SIDEBAR */
.box{
  background:var(--bg-box);
  border-radius:14px;
  padding:14px 14px 12px;
  border:1px solid var(--border-soft);
  box-shadow:var(--shadow-soft);
  margin-bottom:14px;
}
.box h2{
  font-size:16px;margin:0 0 8px;
}
.input{
  width:100%;padding:8px 10px;border-radius:10px;
  border:1px solid var(--border-soft);outline:none;
  background:var(--bg-card);color:var(--text);
}
.chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px;}
.chip{
  border-radius:999px;border:1px solid var(--border-soft);
  padding:4px 10px;font-size:13px;
  background:var(--bg-card);color:var(--text);
  cursor:pointer;
}
.chip:hover{background:var(--primary-soft);}
.chip.active{background:var(--primary);color:#fff;border-color:var(--primary);}

/* AI SUMMARY */
.ai-summary-list{
  font-size:13px;margin:4px 0 0;padding-left:18px;
}
.ai-summary-list li{margin-bottom:3px;}
.btn-main{
  margin-top:6px;
  background:var(--primary);color:#fff;border:none;
  border-radius:8px;font-size:13px;padding:6px 10px;
  cursor:pointer;
}
.btn-main:hover{opacity:.92;}
.small{font-size:11px;color:var(--text-muted);margin-top:4px;display:block;}

/* STORM BANNER */
.storm{
  border-left:4px solid #ef4444;
}
.hidden{display:none;}

/* CONTENT */
.content{min-width:0;}
.section-title{
  font-size:18px;margin:8px 0 4px;
  border-left:4px solid var(--primary);
  padding-left:6px;
}
.filter-row{
  display:flex;flex-wrap:wrap;gap:8px;
  align-items:center;margin-bottom:4px;font-size:13px;
}
.select{
  padding:5px 8px;border-radius:8px;
  border:1px solid var(--border-soft);
  background:var(--bg-card);color:var(--text);
}

/* CARDS */
.news-list{margin-bottom:18px;}
.card{
  background:var(--bg-card);
  border-radius:14px;padding:12px 14px;
  border:1px solid var(--border-soft);
  box-shadow:var(--shadow-soft);
  margin-bottom:8px;
}
.card.ht{border-left:4px solid #dc2626;}
.card.mt{border-left:4px solid #f97316;}
.card.vn{border-left:4px solid #22c55e;}
.card.qt{border-left:4px solid #8b5cf6;}

.card h3{margin:0 0 4px;font-size:16px;}
.meta{
  font-size:12px;color:var(--text-muted);margin-bottom:4px;
}
.badge{
  display:inline-block;padding:2px 7px;border-radius:999px;
  font-size:11px;margin-right:4px;
}
.b-loc{background:var(--primary-soft);}
.b-score-low{background:#dcfce7;color:#166534;}
.b-score-med{background:#fef9c3;color:#92400e;}
.b-score-high{background:#fee2e2;color:#b91c1c;}

.card p{font-size:13px;margin:6px 0 8px;}
.btn-link{
  font-size:13px;padding:5px 9px;border-radius:6px;
  border:none;background:var(--primary);color:#fff;
  cursor:pointer;
}
.btn-link:hover{opacity:.93;}

/* FOOTER */
.footer{
  text-align:center;font-size:12px;
  color:var(--text-muted);padding:16px 8px 20px;
}

/* CHAT ASSISTANT */
.chat-toggle{
  position:fixed;right:18px;bottom:18px;z-index:40;
  width:42px;height:42px;border-radius:999px;
  border:none;background:var(--primary);color:#fff;
  box-shadow:0 4px 12px rgba(0,0,0,0.35);
  cursor:pointer;font-size:20px;
}
.chat-panel{
  position:fixed;right:18px;bottom:72px;z-index:40;
  width:310px;max-height:420px;
  background:var(--bg-card);
  border-radius:16px;
  border:1px solid var(--border-soft);
  box-shadow:0 6px 20px rgba(0,0,0,0.45);
  display:none;flex-direction:column;
}
.chat-header{
  padding:8px 10px;border-bottom:1px solid var(--border-soft);
  font-size:13px;font-weight:600;
  display:flex;justify-content:space-between;align-items:center;
}
.chat-body{
  padding:8px;overflow-y:auto;flex:1;
  font-size:13px;
}
.chat-msg{margin-bottom:6px;}
.chat-msg.me{text-align:right;}
.chat-msg span{
  display:inline-block;padding:4px 8px;border-radius:10px;
}
.chat-msg.me span{
  background:var(--primary);color:#fff;
}
.chat-msg.bot span{
  background:var(--bg-box);color:var(--text);
}
.chat-input-row{
  border-top:1px solid var(--border-soft);
  padding:6px;display:flex;gap:6px;
}
.chat-input-row input{
  flex:1;border-radius:999px;border:1px solid var(--border-soft);
  padding:5px 9px;font-size:13px;background:var(--bg-card);color:var(--text);
}
.chat-input-row button{
  border-radius:999px;border:none;background:var(--primary);color:#fff;
  padding:5px 10px;font-size:13px;cursor:pointer;
}
</style>
</head>

<body><button onclick="location.href='index.html'" style="position:fixed;top:10px;left:10px;z-index:9999;">‚¨Ö Trang ch√≠nh</button>

<header class="topbar">
  <div class="brand">
    üåßÔ∏è SafeRoute AI
    <span>Dashboard Th·ªùi ti·∫øt & Thi√™n tai</span>
  </div>
  <div class="top-actions">
    <button id="darkToggle" class="btn-chip">üåô Dark</button>
  </div>
</header>

<main class="layout">

  <!-- SIDEBAR LEFT -->
  <aside class="sidebar">

    <section class="box">
      <h2>üîç T√¨m ki·∫øm & l·ªçc</h2>
      <input id="searchInput" class="input" placeholder="Nh·∫≠p: b√£o, l≈©, H√† Tƒ©nh, H∆∞∆°ng Kh√™...">
      <div class="chips">
        <button class="chip filter-chip" data-key="">T·∫•t c·∫£</button>
        <button class="chip filter-chip" data-key="b√£o">B√£o</button>
        <button class="chip filter-chip" data-key="l≈©">L≈©</button>
        <button class="chip filter-chip" data-key="m∆∞a l·ªõn">M∆∞a l·ªõn</button>
        <button class="chip filter-chip" data-key="√°p th·∫•p">√Åp th·∫•p</button>
        <button class="chip filter-chip" data-key="s·∫°t l·ªü">S·∫°t l·ªü</button>
      </div>
    </section>

    <section class="box">
      <h2>üß† AI T·ªïng h·ª£p 1 ph√∫t</h2>
      <button id="btnSummary" class="btn-main">‚ñ∂ T·∫°o t·ªïng h·ª£p</button>
      <button id="btnSpeakSummary" class="btn-main" style="margin-left:4px;">üîä Nghe</button>
      <ul id="summaryList" class="ai-summary-list"></ul>
      <span class="small">AI mini d·ª±a tr√™n tin 24h g·∫ßn nh·∫•t, kh√¥ng s·ª≠ d·ª•ng API b√™n ngo√†i.</span>
    </section>

    <section id="stormBanner" class="box storm hidden">
      <h2>üö® Tin b√£o / l≈© n·ªïi b·∫≠t</h2>
      <p id="stormText" style="font-size:13px;margin:4px 0 8px;">ƒêang qu√©t d·ªØ li·ªáu...</p>
      <button id="btnStormJump" class="btn-main" style="width:100%;">üëÄ Xem tin nguy hi·ªÉm nh·∫•t</button>
    </section>

  </aside>

  <!-- MAIN CONTENT -->
  <section class="content">

    <div class="filter-row">
      <span>üìç L·ªçc theo huy·ªán/x√£ (AI nh·∫≠n di·ªán):</span>
      <select id="locationFilter" class="select">
        <option value="">T·∫•t c·∫£ ƒë·ªãa ph∆∞∆°ng</option>
        <option value="ha-tinh">H√† Tƒ©nh (to√†n t·ªânh)</option>
        <option value="huong-khe">H∆∞∆°ng Kh√™</option>
        <option value="ky-anh">K·ª≥ Anh</option>
        <option value="duc-tho">ƒê·ª©c Th·ªç</option>
        <option value="hong-linh">H·ªìng Lƒ©nh</option>
        <option value="thach-ha">Th·∫°ch H√†</option>
        <option value="nghe-an">Ngh·ªá An</option>
        <option value="quang-binh">Qu·∫£ng B√¨nh</option>
        <option value="quang-tri">Qu·∫£ng Tr·ªã</option>
        <option value="thua-thien-hue">Th·ª´a Thi√™n Hu·∫ø</option>
        <option value="quang-nam">Qu·∫£ng Nam</option>
        <option value="mien-trung">Mi·ªÅn Trung (kh√°c)</option>
      </select>
    </div>

    <h2 class="section-title">üìç H√† Tƒ©nh</h2>
    <div id="newsHT" class="news-list"></div>

    <h2 class="section-title">‚õ∞Ô∏è Mi·ªÅn Trung</h2>
    <div id="newsMT" class="news-list"></div>

    <h2 class="section-title">üáªüá≥ Vi·ªát Nam</h2>
    <div id="newsVN" class="news-list"></div>

    <h2 class="section-title">üåç Qu·ªëc t·∫ø</h2>
    <div id="newsQT" class="news-list"></div>

  </section>
</main>

<footer class="footer">
  ¬© 2025 SafeRoute AI ‚Äî Th·ª≠ nghi·ªám Dashboard Th·ªùi ti·∫øt & Thi√™n tai (Mini AI offline)
</footer>

<!-- CHAT ASSISTANT -->
<button id="chatToggle" class="chat-toggle">üí¨</button>
<div id="chatPanel" class="chat-panel">
  <div class="chat-header">
    <span>Tr·ª£ l√Ω th·ªùi ti·∫øt SafeRoute</span>
    <button id="chatClose" class="btn-chip" style="border:none;background:transparent;color:var(--text);">‚úï</button>
  </div>
  <div id="chatBody" class="chat-body"></div>
  <div class="chat-input-row">
    <input id="chatInput" placeholder="H·ªèi: H√† Tƒ©nh c√≥ m∆∞a kh√¥ng?">
    <button id="chatSend">G·ª≠i</button>
  </div>
</div>
<script>
// ==============================
// C·∫§U H√åNH RSS
// ==============================
const FEED_HT = [
  ["B√°o H√† Tƒ©nh", "https://baohatinh.vn/rss/xa-hoi-5.rss"],
  ["HTTV", "https://www.httv.vn/rss/thoi-su"],
  ["VOV Mi·ªÅn Trung", "https://vov.vn/rss/mien-trung-314.rss"]
];
const FEED_MT = [
  ["VNE Mi·ªÅn Trung", "https://vnexpress.net/rss/mien-trung.rss"],
  ["Vietnamnet MT", "https://vietnamnet.vn/rss/mien-trung.rss"],
  ["Qu·∫£ng B√¨nh", "https://baoquangbinh.vn/rss/thoi-su/"],
  ["Qu·∫£ng Tr·ªã", "https://baoquangtri.vn/rss/thoi-su.rss"],
  ["Hu·∫ø", "https://baothuathienhue.vn/rss/thoi-su.rss"]
];
const FEED_VN = [
  ["VNE M√¥i tr∆∞·ªùng", "https://vnexpress.net/rss/thoi-su/moi-truong.rss"],
  ["Tu·ªïi Tr·∫ª MT", "https://tuoitre.vn/rss/thoi-su/moi-truong.rss"],
  ["Zing Th·ªùi ti·∫øt", "https://zingnews.vn/rss/thoi-tiet.xml"]
];
const FEED_QT = [
  ["NASA Earth", "https://earthobservatory.nasa.gov/feeds/earth-observatory.rss"],
  ["Reuters Climate", "https://www.reuters.com/rssFeed/climate.xml"]
];

// T·ª´ kh√≥a nh·∫≠n di·ªán b√£o/l≈©
const STORM_KEYWORDS = [
  "b√£o","√°p th·∫•p","l≈©","l·ª•t","m∆∞a l·ªõn","s·∫°t l·ªü",
  "ng·∫≠p","gi√¥ng l·ªëc","d√¥ng l·ªëc","flood","storm","typhoon","tropical"
];

let allCards = [];       // DOM
let allArticles = [];    // d·ªØ li·ªáu
let stormArticles = [];  // c√°c tin nguy hi·ªÉm
let summaryText = "";    // l∆∞u b·∫£n t·ªïng h·ª£p AI

// ==============================
// DARK MODE
// ==============================
function initDarkMode(){
  if(window.matchMedia("(prefers-color-scheme: dark)").matches){
    document.body.classList.add("dark");
  }
  const btn = document.getElementById("darkToggle");
  const sync = () => btn.textContent =
    document.body.classList.contains("dark") ? "‚òÄÔ∏è Light" : "üåô Dark";
  btn.onclick = () => {
    document.body.classList.toggle("dark");
    sync();
  };
  sync();
}

// ==============================
// LOAD RSS (RSS2JSON ‚Äì nhanh, kh√¥ng l·ªói CORS)
// ==============================
async function loadRSS(url){
  const api = "https://api.rss2json.com/v1/api.json?rss_url=" + encodeURIComponent(url);
  try {
    const r = await fetch(api);
    const j = await r.json();
    return j.items || [];
  } catch(e){
    console.log("RSS Error:", e);
    return [];
  }
}

// ==============================
// AI MINI ‚Äî NH·∫¨N DI·ªÜN HUY·ªÜN/X√É
// ==============================
const LOCATION_RULES = [
  {key:"huong-khe", label:"H∆∞∆°ng Kh√™", patterns:["h∆∞∆°ng kh√™"]},
  {key:"ky-anh", label:"K·ª≥ Anh", patterns:["k·ª≥ anh"]},
  {key:"duc-tho", label:"ƒê·ª©c Th·ªç", patterns:["ƒë·ª©c th·ªç"]},
  {key:"hong-linh", label:"H·ªìng Lƒ©nh", patterns:["h·ªìng lƒ©nh"]},
  {key:"thach-ha", label:"Th·∫°ch H√†", patterns:["th·∫°ch h√†"]},
  {key:"ha-tinh", label:"H√† Tƒ©nh", patterns:["h√† tƒ©nh"]},
  {key:"nghe-an", label:"Ngh·ªá An", patterns:["ngh·ªá an"]},
  {key:"quang-binh", label:"Qu·∫£ng B√¨nh", patterns:["qu·∫£ng b√¨nh"]},
  {key:"quang-tri", label:"Qu·∫£ng Tr·ªã", patterns:["qu·∫£ng tr·ªã"]},
  {key:"thua-thien-hue", label:"Th·ª´a Thi√™n Hu·∫ø", patterns:["th·ª´a thi√™n hu·∫ø","hu·∫ø"]},
  {key:"quang-nam", label:"Qu·∫£ng Nam", patterns:["qu·∫£ng nam"]},
  {key:"mien-trung", label:"Mi·ªÅn Trung", patterns:["mi·ªÅn trung","trung b·ªô"]}
];

function detectLocation(text){
  for(const rule of LOCATION_RULES){
    for(const p of rule.patterns){
      if(text.includes(p)) return rule;
    }
  }
  return null;
}

// ==============================
// AI MINI ‚Äî IMPACT SCORE 0‚Äì10
// ==============================
function computeImpactScore(text){
  let s = 1;
  if(text.includes("b√£o")) s+=4;
  if(text.includes("√°p th·∫•p")) s+=3;
  if(text.includes("l≈©")||text.includes("l·ª•t")) s+=4;
  if(text.includes("m∆∞a l·ªõn")) s+=2;
  if(text.includes("m∆∞a r·∫•t to")) s+=3;
  if(text.includes("ng·∫≠p")) s+=2;
  if(text.includes("s·∫°t l·ªü")) s+=3;
  if(text.includes("gi√≥ m·∫°nh")) s+=2;
  if(text.includes("thi·ªát h·∫°i")) s+=2;
  if(text.includes("t·ª≠ vong")) s+=3;
  if(s>10) s=10;
  return s;
}

function scoreClass(score){
  if(score <4) return "b-score-low";
  if(score <7) return "b-score-med";
  return "b-score-high";
}

// ==============================
// T·∫†O CARD B√ÄI B√ÅO
// ==============================
let articleIdCounter = 0;
function createCard(article, cssClass, container){
  const card = document.createElement("div");
  card.className = "card " + cssClass;

  const text = (article.title + " " + article.description).toLowerCase();
  const loc = detectLocation(text);
  const locLabel = loc ? loc.label : "Kh√¥ng r√µ";
  const locKey = loc ? loc.key : "";

  const score = computeImpactScore(text);
  const isStorm = STORM_KEYWORDS.some(k => text.includes(k));
  const id = articleIdCounter++;

  const dt = article.date.toLocaleString("vi-VN");

  card.dataset.text = text;
  card.dataset.location = locKey;
  card.dataset.score = score;
  card.dataset.articleId = id;

  let riskName = score<4 ? "Th·∫•p" : (score<7 ? "Trung b√¨nh" : "Cao");

  card.innerHTML = `
    <h3>${article.title}</h3>
    <div class="meta">
      <span class="badge b-loc">üìç ${locLabel}</span>
      <span class="badge ${scoreClass(score)}">‚ö† ${score}/10 ‚Äì ${riskName}</span>
      ¬∑ üì∞ ${article.source}
      ¬∑ üïí ${dt}
    </div>
    <p>${article.summary}</p>
    <button class="btn-link" onclick="window.open('${article.link}','_blank')">
      üîó Xem b√†i g·ªëc
    </button>
  `;

  container.appendChild(card);

  allCards.push(card);
  allArticles.push({id, ...article, text, locKey, locLabel, score, isStorm });

  if(isStorm || score>=7) stormArticles.push(card);
}

// ==============================
// LOAD 1 NH√ìM TIN
// ==============================
async function loadGroup(feedList, containerId, cssClass, limit){
  const box = document.getElementById(containerId);
  box.innerHTML = "<div class='card'>‚è≥ ƒêang t·∫£i...</div>";

  let items = [];
  for(const [src,url] of feedList){
    const rss = await loadRSS(url);
    rss.slice(0,8).forEach(i=>{
      const clean = (i.description || "").replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim();
      items.push({
        source:src,
        title:i.title,
        link:i.link,
        description:clean,
        summary:clean.slice(0,220) + "...",
        date:new Date(i.pubDate || Date.now())
      });
    });
  }

  items.sort((a,b)=>b.date - a.date);
  items = items.slice(0,limit);

  box.innerHTML="";
  items.forEach(a=>createCard(a, cssClass, box));
}

// ==============================
// SEARCH & FILTER
// ==============================
function applyFilters(){
  const q = document.getElementById("searchInput").value.toLowerCase();
  const loc = document.getElementById("locationFilter").value;
  const chip = document.querySelector(".filter-chip.active");
  const kw = chip ? chip.dataset.key : "";

  allCards.forEach(c=>{
    let ok=true;
    if(q && !c.dataset.text.includes(q)) ok=false;
    if(kw && !c.dataset.text.includes(kw)) ok=false;
    if(loc && c.dataset.location !== loc) ok=false;
    c.style.display = ok ? "block":"none";
  });
}

function initSearchFilters(){
  document.getElementById("searchInput").oninput = applyFilters;
  document.getElementById("locationFilter").onchange = applyFilters;

  document.querySelectorAll(".filter-chip").forEach(btn=>{
    btn.onclick = ()=>{
      document.querySelectorAll(".filter-chip").forEach(b=>b.classList.remove("active"));
      if(btn.dataset.key) btn.classList.add("active");
      else document.getElementById("searchInput").value="";
      applyFilters();
    };
  });
}
// ==============================
// AI T·ªîNG H·ª¢P CHI TI·∫æT (N√ÇNG C·∫§P PRO)
// ==============================
function buildAISummary() {
  const listEl = document.getElementById("summaryList");
  summaryText = "";
  listEl.innerHTML = "";

  if (allArticles.length === 0) {
    listEl.innerHTML = "<li>Ch∆∞a c√≥ d·ªØ li·ªáu.</li>";
    return;
  }

  const sorted = [...allArticles].sort((a,b)=>b.date - a.date).slice(0,40);

  // Nh√≥m theo ƒë·ªãa ph∆∞∆°ng
  const groups = {};
  for(const a of sorted){
    const key = a.locLabel || "Kh√°c";
    if(!groups[key]) groups[key]=[];
    groups[key].push(a);
  }

  const PRIOR = ["H∆∞∆°ng Kh√™","K·ª≥ Anh","ƒê·ª©c Th·ªç","H·ªìng Lƒ©nh","Th·∫°ch H√†","H√† Tƒ©nh"];

  let out = [];
  out.push("üìä *T·ªïng h·ª£p thi√™n tai - th·ªùi ti·∫øt 24h qua (AI)*");

  // ∆Øu ti√™n ph√¢n t√≠ch H√† Tƒ©nh theo huy·ªán
  for(const loc of PRIOR){
    const arr = groups[loc];
    if(!arr) continue;

    const severe = arr.filter(a=>a.score>=5);
    const max = Math.max(...arr.map(a=>a.score));

    out.push(
      `\nüìç **${loc}**` +
      `\n‚Ä¢ Tin ghi nh·∫≠n: ${arr.length}` +
      `\n‚Ä¢ Tin nguy hi·ªÉm (>=5 ƒëi·ªÉm): ${severe.length}` +
      `\n‚Ä¢ M·ª©c r·ªßi ro cao nh·∫•t: ${max}/10` +
      `\n‚Ä¢ Ti√™u ƒëi·ªÉm: "${arr[0].title.slice(0,80)}..."`
    );
  }

  // T·ªïng quan mi·ªÅn Trung
  const MT = sorted.filter(a =>
    ["nghe-an","quang-binh","quang-tri","thua-thien-hue","quang-nam","mien-trung"]
      .includes(a.locKey)
  );

  if(MT.length){
    const max = Math.max(...MT.map(a=>a.score));
    out.push(
      `\n‚õ∞Ô∏è **Mi·ªÅn Trung ‚Äì T·ªïng quan**`+
      `\n‚Ä¢ Tin ghi nh·∫≠n: ${MT.length}`+
      `\n‚Ä¢ R·ªßi ro cao nh·∫•t: ${max}/10`+
      `\n‚Ä¢ Ti√™u ƒëi·ªÉm: "${MT[0].title.slice(0,80)}..."`
    );
  }

  // D·ª± b√°o 24h t·ªõi
  const maxScore = Math.max(...sorted.map(a=>a.score));
  let forecast="";

  if(maxScore>=8){
    forecast="Nguy c∆° r·∫•t cao: m∆∞a ƒë·∫∑c bi·ªát to, gi√≥ m·∫°nh, l≈© qu√©t v√† ng·∫≠p s√¢u t·∫°i m·ªôt s·ªë huy·ªán H√† Tƒ©nh v√† B·∫Øc Trung B·ªô.";
  } else if(maxScore>=5){
    forecast="Nguy c∆° trung b√¨nh: m∆∞a to c·ª•c b·ªô, kh·∫£ nƒÉng xu·∫•t hi·ªán l≈© nh·ªè v√† ng·∫≠p ·ªü v√πng tr≈©ng.";
  } else {
    forecast="Nguy c∆° th·∫•p: th·ªùi ti·∫øt ·ªïn ƒë·ªãnh, ch·ªâ c√≥ m∆∞a r√†o nh·∫π r·∫£i r√°c.";
  }

  out.push(`\nüß≠ **D·ª± b√°o 24h t·ªõi:**\n‚Ä¢ ${forecast}`);

  // Khuy·∫øn ngh·ªã
  out.push(
    `\nüìù **Khuy·∫øn ngh·ªã:**`+
    `\n‚Ä¢ Theo d√µi m·ª±c n∆∞·ªõc s√¥ng v√† b·∫£n tin KTTV.`+
    `\n‚Ä¢ H·∫°n ch·∫ø ƒëi l·∫°i ban ƒë√™m n·∫øu c√≥ m∆∞a l·ªõn.`+
    `\n‚Ä¢ Ki·ªÉm tra tho√°t n∆∞·ªõc xung quanh nh√†.`,
  );

  // Render UI
  listEl.innerHTML="";
  out.forEach(line=>{
    const li=document.createElement("li");
    li.textContent=line.replace(/\*\*/g,"");
    listEl.appendChild(li);
  });

  summaryText = out.join("\n");
}

// ==============================
// GI·ªåNG ƒê·ªåC AI (WEB SPEECH)
// ==============================
function speakSummary(){
  if(!("speechSynthesis" in window)){
    alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªçc gi·ªçng.");
    return;
  }
  if(!summaryText){ buildAISummary(); }
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(summaryText);
  u.lang="vi-VN";
  u.rate=1.0;
  window.speechSynthesis.speak(u);
}

// ==============================
// BANNER TIN B√ÉO / L≈®
// ==============================
function updateStormBanner(){
  const banner=document.getElementById("stormBanner");
  const txt=document.getElementById("stormText");
  const btn=document.getElementById("btnStormJump");

  if(stormArticles.length===0){
    banner.classList.add("hidden");
    return;
  }
  banner.classList.remove("hidden");

  const first = stormArticles[0];
  const id = first.dataset.articleId;
  const art = allArticles.find(a=>String(a.id)==String(id));

  txt.textContent = 
    `C√≥ ${stormArticles.length} tin b√£o/l≈© ho·∫∑c nguy c∆° cao. N·ªïi b·∫≠t: "${art.title.slice(0,70)}..."`;

  btn.onclick =()=>{
    first.scrollIntoView({behavior:"smooth"});
    first.style.outline="3px solid #ef4444";
    setTimeout(()=>first.style.outline="none",2500);
  };
}

// ==============================
// CHATBOT MINI AI ‚Äì TR·∫¢ L·ªúI T·ª∞ ƒê·ªòNG
// ==============================
function appendChatMsg(msg, who){
  const box = document.getElementById("chatBody");
  const div = document.createElement("div");
  div.className = "chat-msg " + who;
  const span=document.createElement("span");
  span.textContent=msg;
  div.appendChild(span);
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

function answerChat(q){
  const text=q.toLowerCase();

  if(allArticles.length===0)
    return "D·ªØ li·ªáu ƒëang t·∫£i, vui l√≤ng th·ª≠ l·∫°i sau √≠t ph√∫t.";

  // H·ªèi t·ªïng h·ª£p
  if(text.includes("t·ªïng h·ª£p")||text.includes("t√≥m t·∫Øt")){
    buildAISummary();
    return summaryText;
  }

  // T√¨m ƒë·ªãa ph∆∞∆°ng
  let loc=null;
  for(const r of LOCATION_RULES){
    for(const p of r.patterns){
      if(text.includes(p)){ loc=r; break; }
    }
    if(loc) break;
  }

  const rainKey=["m∆∞a","m∆∞a l·ªõn","th·ªùi ti·∫øt"];
  const floodKey=["l≈©","l·ª•t","ng·∫≠p"];
  const stormKey=["b√£o","√°p th·∫•p"];

  if(loc && (rainKey.some(k=>text.includes(k)) || 
             floodKey.some(k=>text.includes(k)) ||
             stormKey.some(k=>text.includes(k)))){

    const rel = allArticles
      .filter(a=>a.locKey===loc.key)
      .sort((a,b)=>b.date-a.date)
      .slice(0,8);

    if(rel.length===0)
      return `Kh√¥ng th·∫•y tin ƒë√°ng ch√∫ √Ω t·∫°i ${loc.label} trong d·ªØ li·ªáu m·ªõi nh·∫•t.`;

    const severe = rel.filter(a=>a.score>=5);
    let msg = `Khu v·ª±c ${loc.label} c√≥ ${rel.length} tin th·ªùi ti·∫øt/thi√™n tai. `;

    if(severe.length){
      msg += `Trong ƒë√≥ ${severe.length} tin ·ªü m·ª©c nguy c∆° trung b√¨nh ‚Üí cao. `;
      msg += "Ti√™u ƒëi·ªÉm: " + severe.slice(0,2).map(a=>`"${a.title}"`).join("; ");
    } else {
      msg += "H·∫ßu h·∫øt ·ªü m·ª©c nguy c∆° th·∫•p. Tin n·ªïi b·∫≠t: ";
      msg += rel.slice(0,2).map(a=>`"${a.title}"`).join("; ");
    }
    return msg;
  }

  // H·ªèi v·ªÅ b√£o n√≥i chung
  if(stormKey.some(k=>text.includes(k))){
    const storms = allArticles.filter(a=>a.isStorm||a.score>=7)
      .sort((a,b)=>b.date-a.date).slice(0,5);
    if(storms.length===0) return "Hi·ªán ch∆∞a c√≥ tin b√£o n·ªïi b·∫≠t trong d·ªØ li·ªáu.";
    return "Tin b√£o m·ªõi nh·∫•t: " + storms.map(a=>a.title).join("; ");
  }

  return "B·∫°n c√≥ th·ªÉ h·ªèi: 'H∆∞∆°ng Kh√™ c√≥ l≈© kh√¥ng?', 'T·ªïng h·ª£p 1 ph√∫t', 'C√≥ tin b√£o m·ªõi kh√¥ng?'.";
}

function initChat(){
  const toggle=document.getElementById("chatToggle");
  const panel=document.getElementById("chatPanel");
  const close=document.getElementById("chatClose");
  const send=document.getElementById("chatSend");
  const input=document.getElementById("chatInput");

  toggle.onclick=()=>{ panel.style.display = panel.style.display==="flex"?"none":"flex"; };
  close.onclick=()=>{ panel.style.display="none"; };

  function sendMsg(){
    const q=input.value.trim();
    if(!q) return;
    appendChatMsg(q,"me");
    input.value="";
    const res = answerChat(q);
    appendChatMsg(res,"bot");
  }

  send.onclick=sendMsg;
  input.addEventListener("keydown",e=>{
    if(e.key==="Enter") sendMsg();
  });

  appendChatMsg("Xin ch√†o! T√¥i l√† tr·ª£ l√Ω SafeRoute AI mini. B·∫°n c√≥ th·ªÉ h·ªèi v·ªÅ b√£o, l≈©, m∆∞a ho·∫∑c y√™u c·∫ßu t·ªïng h·ª£p 1 ph√∫t.", "bot");
}

// ==============================
// KH·ªûI T·∫†O H·ªÜ TH·ªêNG
// ==============================
async function init(){
  initDarkMode();
  initSearchFilters();

  allCards=[]; 
  allArticles=[];
  stormArticles=[];

  await Promise.all([
    loadGroup(FEED_HT,"newsHT","ht",12),
    loadGroup(FEED_MT,"newsMT","mt",10),
    loadGroup(FEED_VN,"newsVN","vn",8),
    loadGroup(FEED_QT,"newsQT","qt",4)
  ]);

  buildAISummary();
  updateStormBanner();
  initChat();

  document.getElementById("btnSummary").onclick = buildAISummary;
  document.getElementById("btnSpeakSummary").onclick = speakSummary;
}

init();
</script>

</body>
</html>
