<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>üèû Reservoir AI v4 PRO ‚Äî D·ª± b√°o, Li√™n h·ªì & B√°o c√°o</title>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- Chart.js cho bi·ªÉu ƒë·ªì -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family:'Segoe UI',Roboto,sans-serif;
  background:linear-gradient(135deg,#e6f3ff,#ffffff);
  margin:0;padding:0;color:#111;
}
header{
  background:#0066c4;color:white;padding:14px 20px;
  font-size:20px;font-weight:600;
  box-shadow:0 3px 10px rgba(0,0,0,0.25);
}
nav{
  display:flex;justify-content:center;gap:8px;
  background:#e8f0ff;padding:10px;
}
button.tab{
  background:#fff;border:2px solid #0078d7;color:#0078d7;
  border-radius:999px;padding:8px 16px;cursor:pointer;
  font-weight:600;font-size:14px;
  transition:0.25s;
}
button.tab.active{
  background:#0078d7;color:white;
  transform:scale(1.05);
}
.container{
  max-width:1000px;margin:20px auto;background:white;
  border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,0.12);
  padding:20px;animation:fadeIn 0.25s;
}
@keyframes fadeIn{
  from{opacity:0;transform:translateY(4px);}
  to{opacity:1;transform:translateY(0);}
}
input,select{
  padding:8px;border:1px solid #ccc;border-radius:6px;
  width:220px;margin:4px 0;
}
label{font-size:14px;font-weight:600;}
.btn-primary{
  background:#0078d7;color:white;border:none;
  border-radius:8px;padding:10px 16px;margin-top:10px;
  cursor:pointer;font-size:14px;font-weight:600;
  transition:0.25s;
}
.btn-primary:hover{background:#005fa3;}
.result{
  background:#eef7ff;border-left:5px solid #0078d7;
  padding:12px 16px;border-radius:8px;margin-top:16px;
  font-size:14px;
}
.result table{
  width:100%;border-collapse:collapse;margin-top:8px;
  font-size:13px;
}
.result th,.result td{
  border:1px solid #c4ddff;padding:6px 8px;text-align:center;
}
.badge{
  display:inline-block;padding:2px 8px;border-radius:999px;
  font-size:11px;margin-left:4px;
}
.badge-safe{background:#d4f8e8;color:#097b3a;}
.badge-warn{background:#fff6c4;color:#8a6d00;}
.badge-high{background:#ffe0c4;color:#993c00;}
.badge-emg{background:#ffd4d4;color:#a30000;}
footer{
  text-align:center;color:#555;font-size:13px;margin:20px 0;
}
.section-grid{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:16px;
}
.card{
  background:#f8fbff;border-radius:10px;padding:12px 14px;
  border:1px solid #deecff;font-size:13px;
}
.card h3{
  margin:0 0 6px;font-size:15px;
}
small{color:#555;}
#chartContainer{
  margin-top:18px;
}
canvas{max-width:100%;height:260px;}
</style>
</head>
<body><button onclick="location.href='index.html'" style="position:fixed;top:10px;left:10px;z-index:9999;">‚¨Ö Trang ch√≠nh</button>

<header>üèû Reservoir AI v4 PRO ‚Äî D·ª± b√°o m·ª±c n∆∞·ªõc, Li√™n h·ªì & B√°o c√°o PDF</header>

<nav>
  <button class="tab active" onclick="showTab('aiTab', this)">üß† AI D·ª± b√°o</button>
  <button class="tab" onclick="showTab('flowTab', this)">üåä Li√™n h·ªì & S√¥ng</button>
  <button class="tab" onclick="showTab('reportTab', this)">üìÑ B√°o c√°o PDF / SOS</button>
</nav>

<!-- TAB 1: AI D·ª∞ B√ÅO -->
<div id="aiTab" class="container">
  <h2>üß† D·ª± b√°o m·ª±c n∆∞·ªõc v·ªõi 3 k·ªãch b·∫£n m∆∞a & AI x·∫£ t·ªëi ∆∞u</h2>

  <div class="section-grid">
    <div class="card">
      <h3>üìç Ch·ªçn h·ªì ch·ª©a</h3>
      <label>H·ªì ch·ª©a:</label><br>
      <select id="resSelect" onchange="onReservoirChange()">
        <option value="ke_go">H·ªì K·∫ª G·ªó</option>
        <option value="ngan_truoi">H·ªì Ng√†n Tr∆∞∆°i</option>
        <option value="song_rac">H·ªì S√¥ng R√°c</option>
        <option value="song_tri">H·ªì S√¥ng Tr√≠</option>
        <option value="thac_trang">H·ªì Th√°c Tr·∫Øng</option>
        <option value="thuy_yen">H·ªì Th·ªßy Y√™n ‚Äì Th·ªßy Cam</option>
      </select>
      <p style="margin-top:6px;font-size:13px;">
        MN gi·ªõi h·∫°n l≈© hi·ªán t·∫°i: <b><span id="infoLimit">34.0</span> m</b><br>
        M·ª±c n∆∞·ªõc c∆° s·ªü: <b><span id="infoZ0">30.5</span> m</b>
      </p>
    </div>

    <div class="card">
      <h3>üåß Th√¥ng tin ƒë·∫ßu v√†o</h3>
      <label>L∆∞·ª£ng m∆∞a d·ª± ki·∫øn (mm):</label><br>
      <input type="number" id="rain" value="120"><br>

      <label>L∆∞u l∆∞·ª£ng v√†o Q<sub>in</sub> (m¬≥/s):</label><br>
      <input type="number" id="qin" value="220"><br>

      <label>L∆∞u l∆∞·ª£ng x·∫£ hi·ªán t·∫°i Q<sub>out</sub> (m¬≥/s):</label><br>
      <input type="number" id="qout" value="180"><br>

      <button class="btn-primary" onclick="runForecast()">‚ñ∂ D·ª± b√°o 3 k·ªãch b·∫£n</button>
    </div>

    <div class="card">
      <h3>ü§ñ G·ª£i √Ω x·∫£ t·ªëi ∆∞u (AI)</h3>
      <p>
        Q<sub>out</sub> khuy·∫øn ngh·ªã ƒë·ªÉ gi·ªØ m·ª±c n∆∞·ªõc trong v√πng an to√†n:
      </p>
      <input type="number" id="qoutOpt" readonly style="background:#eef7ff;">
      <p style="font-size:12px;margin-top:4px;">
        <b>L∆∞u √Ω:</b> Gi√° tr·ªã ch·ªâ mang t√≠nh tham kh·∫£o, c·∫ßn k·∫øt h·ª£p quy tr√¨nh v·∫≠n h√†nh li√™n h·ªì & ch·ªâ ƒë·∫°o PCTT.
      </p>
    </div>
  </div>

  <div id="aiResult" class="result" style="display:none;"></div>

  <div id="safetyResult" class="result" style="display:none;"></div>

  <div id="chartContainer" style="display:none;">
    <h3>üìà Bi·ªÉu ƒë·ªì m·ª±c n∆∞·ªõc 3 k·ªãch b·∫£n</h3>
    <canvas id="forecastChart"></canvas>
  </div>
</div>

<!-- TAB 2: LI√äN H·ªí -->
<div id="flowTab" class="container" style="display:none;">
  <h2>üåä M√¥ ph·ªèng d√≤ng ch·∫£y li√™n h·ªì & S√¥ng La (phi√™n b·∫£n ƒë∆°n gi·∫£n)</h2>

  <label>L∆∞·ª£ng m∆∞a trung b√¨nh v√πng th∆∞·ª£ng ngu·ªìn (mm):</label><br>
  <input type="number" id="rainFlow" value="100"><br>

  <button class="btn-primary" onclick="simulateFlow()">‚ñ∂ M√¥ ph·ªèng d√≤ng ch·∫£y</button>

  <div id="flowResult" class="result" style="display:none;"></div>
</div>

<!-- TAB 3: REPORT / PDF -->
<div id="reportTab" class="container" style="display:none;">
  <h2>üìÑ Xu·∫•t b√°o c√°o PDF n√¢ng cao & SOS</h2>

  <div class="section-grid">
    <div class="card">
      <h3>Th√¥ng tin b√°o c√°o</h3>
      <label>T√™n h·ªì ch·ª©a:</label><br>
      <input id="repName" value="H·ªì K·∫ª G·ªó"><br>

      <label>M·ª±c n∆∞·ªõc hi·ªán t·∫°i (m):</label><br>
      <input id="repNow" value="32.5"><br>

      <label>D·ª± b√°o sau 24h (m):</label><br>
      <input id="repFuture" value="33.8"><br>

      <label>M·ª©c c·∫£nh b√°o:</label><br>
      <select id="repLevel">
        <option>üü¢ An to√†n</option>
        <option>üü° C·∫£nh b√°o</option>
        <option>üü† Nguy c∆° cao</option>
        <option>üî¥ Kh·∫©n c·∫•p</option>
      </select>
    </div>

    <div class="card">
      <h3>H√†nh ƒë·ªông</h3>
      <button class="btn-primary" onclick="exportPDF()">üìÑ Xu·∫•t b√°o c√°o PDF n√¢ng cao</button><br>
      <button class="btn-primary" style="background:#d7263d;margin-top:8px;" onclick="sendSOS()">üö® G·ª≠i SOS</button>
      <p id="reportStatus" style="margin-top:10px;font-size:13px;color:#333;"></p>
      <small>N·∫øu ch∆∞a c√≥ d·ª± b√°o g·∫ßn nh·∫•t, h√£y quay l·∫°i tab üß† AI D·ª± b√°o ƒë·ªÉ ch·∫°y d·ª± b√°o tr∆∞·ªõc khi xu·∫•t PDF.</small>
    </div>
  </div>
</div>

<footer>¬© 2025 SafeRoute AI ‚Äî Reservoir Module v4 PRO (AI + Li√™n h·ªì + PDF + Scenarios)</footer>

<script>
// =========================
//  DATABASE H·ªí CH·ª®A
// =========================
const reservoirDB = {
  "ke_go": {
    name: "H·ªì K·∫ª G·ªó",
    z0: 30.5,
    limit: 34.0,
    minLevel: 25.0,
    designFlood: 36.0,
    coeffRain: 0.060,
    coeffQin: 0.045,
    coeffQout: -0.040,
    qMax: 600
  },
  "ngan_truoi": {
    name: "H·ªì Ng√†n Tr∆∞∆°i",
    z0: 28.0,
    limit: 39.5,
    minLevel: 24.0,
    designFlood: 41.0,
    coeffRain: 0.055,
    coeffQin: 0.050,
    coeffQout: -0.035,
    qMax: 700
  },
  "song_rac": {
    name: "H·ªì S√¥ng R√°c",
    z0: 26.5,
    limit: 32.5,
    minLevel: 22.0,
    designFlood: 34.0,
    coeffRain: 0.045,
    coeffQin: 0.040,
    coeffQout: -0.030,
    qMax: 400
  },
  "song_tri": {
    name: "H·ªì S√¥ng Tr√≠",
    z0: 31.8,
    limit: 36.0,
    minLevel: 27.0,
    designFlood: 37.5,
    coeffRain: 0.052,
    coeffQin: 0.044,
    coeffQout: -0.035,
    qMax: 450
  },
  "thac_trang": {
    name: "H·ªì Th√°c Tr·∫Øng",
    z0: 29.0,
    limit: 35.0,
    minLevel: 24.0,
    designFlood: 37.0,
    coeffRain: 0.050,
    coeffQin: 0.043,
    coeffQout: -0.032,
    qMax: 500
  },
  "thuy_yen": {
    name: "H·ªì Th·ªßy Y√™n ‚Äì Th·ªßy Cam",
    z0: 18.0,
    limit: 23.5,
    minLevel: 15.0,
    designFlood: 25.0,
    coeffRain: 0.040,
    coeffQin: 0.038,
    coeffQout: -0.028,
    qMax: 350
  }
};

let lastForecast = null;   // l∆∞u k·∫øt qu·∫£ d·ª± b√°o g·∫ßn nh·∫•t cho PDF
let chartInstance = null;  // Chart.js instance

// =========================
//  TAB SWITCH
// =========================
function showTab(tabId,btn){
  document.querySelectorAll(".container").forEach(t=>t.style.display="none");
  document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
  document.getElementById(tabId).style.display="block";
  btn.classList.add("active");
}

// =========================
//  C·∫¨P NH·∫¨T INFO KHI CH·ªåN H·ªí
// =========================
function onReservoirChange(){
  const key = document.getElementById("resSelect").value;
  const res = reservoirDB[key];
  document.getElementById("infoLimit").innerText = res.limit.toFixed(1);
  document.getElementById("infoZ0").innerText = res.z0.toFixed(1);
}

// =========================
//  H√ÄM T√çNH M·ª∞C N∆Ø·ªöC
// =========================
function calcLevels(res, rain, qIn, qOut){
  const {z0, coeffRain:a, coeffQin:b, coeffQout:c} = res;
  const z6  = z0 + a*rain + b*qIn + c*qOut;
  const z12 = z6 + rain*0.010 + qIn*0.008;
  const z24 = z12 + rain*0.015 + qIn*0.012;
  return {z6,z12,z24};
}

// =========================
//  G·ª¢I √ù Qout T·ªêI ∆ØU
// =========================
function suggestOptimalQout(res, rain, qIn){
  const target = res.limit - 0.3; // gi·ªØ d∆∞·ªõi gi·ªõi h·∫°n 0.3 m
  const base = calcLevels(res, rain, qIn, 0).z24;
  // x·∫•p x·ªâ ƒë·ªô nh·∫°y theo Qout
  const z24q100 = calcLevels(res, rain, qIn, 100).z24;
  const c_eff = (z24q100 - base) / 100; // th∆∞·ªùng l√† s·ªë √¢m
  let qOpt;
  if (Math.abs(c_eff) < 1e-6){
    qOpt = 0;
  } else {
    qOpt = (target - base) / c_eff;
  }
  // Gi·ªõi h·∫°n trong [0, qMax]
  qOpt = Math.max(0, Math.min(res.qMax, qOpt));
  return qOpt;
}

// =========================
//  T√çNH TO√ÅN AN TO√ÄN H·ªí
// =========================
function evaluateSafety(res, z24){
  const margin = res.limit - z24;
  let level, badgeClass, advice;
  if (margin >= 1.0){
    level = "üü¢ An to√†n"; badgeClass = "badge-safe";
    advice = "Ti·∫øp t·ª•c v·∫≠n h√†nh b√¨nh th∆∞·ªùng, theo d√µi m∆∞a v√† l∆∞u l∆∞·ª£ng ƒë·∫øn.";
  } else if (margin >= 0 && margin < 1.0){
    level = "üü° C·∫£nh b√°o"; badgeClass = "badge-warn";
    advice = "TƒÉng c∆∞·ªùng quan tr·∫Øc m∆∞a, chu·∫©n b·ªã ph∆∞∆°ng √°n x·∫£ ƒëi·ªÅu ti·∫øt ch·ªß ƒë·ªông.";
  } else if (margin >= -0.5 && margin < 0){
    level = "üü† Nguy c∆° cao"; badgeClass = "badge-high";
    advice = "T·ªï ch·ª©c tr·ª±c ban 24/24, ch·ªß ƒë·ªông tƒÉng l∆∞u l∆∞·ª£ng x·∫£ c√≥ ki·ªÉm so√°t, th√¥ng b√°o h·∫° du.";
  } else {
    level = "üî¥ Kh·∫©n c·∫•p"; badgeClass = "badge-emg";
    advice = "K√≠ch ho·∫°t ph∆∞∆°ng √°n PCTT c·∫•p b√°ch, x·∫£ theo l·ªánh ch·ªâ huy PCTT, c·∫£nh b√°o s∆° t√°n v√πng h·∫° du.";
  }
  const safetyIndex = (z24 - res.minLevel) / (res.designFlood - res.minLevel);
  return {level,badgeClass,advice,safetyIndex};
}

// =========================
//  D·ª∞ B√ÅO 3 K·ªäCH B·∫¢N
// =========================
function runForecast(){
  const key = document.getElementById("resSelect").value;
  const res = reservoirDB[key];
  const rain = Number(document.getElementById("rain").value);
  const qIn  = Number(document.getElementById("qin").value);
  const qOut = Number(document.getElementById("qout").value);

  const scenarios = [
    {id:"low",  label:"M∆∞a th·∫•p (70%)",  factor:0.7},
    {id:"base", label:"M∆∞a d·ª± ki·∫øn (100%)", factor:1.0},
    {id:"high", label:"M∆∞a c·ª±c ƒëoan (150%)", factor:1.5}
  ];

  const resultRows = [];
  const times = [0,6,12,24];
  const seriesLow = [res.z0], seriesBase = [res.z0], seriesHigh = [res.z0];
  let base24 = null;

  scenarios.forEach(s=>{
    const r = rain * s.factor;
    const lv = calcLevels(res, r, qIn, qOut);
    if (s.id==="low")  {seriesLow.push(lv.z6, lv.z12, lv.z24);}
    if (s.id==="base") {seriesBase.push(lv.z6, lv.z12, lv.z24); base24 = lv.z24;}
    if (s.id==="high") {seriesHigh.push(lv.z6, lv.z12, lv.z24);}
    resultRows.push({
      label:s.label,
      rain:r,
      z6:lv.z6,
      z12:lv.z12,
      z24:lv.z24
    });
  });

  // G·ª£i √Ω Qout t·ªëi ∆∞u d·ª±a tr√™n k·ªãch b·∫£n trung b√¨nh
  const qOpt = suggestOptimalQout(res, rain, qIn);
  document.getElementById("qoutOpt").value = qOpt.toFixed(0);

  // ƒê√°nh gi√° an to√†n theo k·ªãch b·∫£n trung b√¨nh
  const safety = evaluateSafety(res, base24);

  // Hi·ªÉn th·ªã b·∫£ng k·∫øt qu·∫£
  let html = `<b>D·ª± b√°o cho h·ªì: ${res.name}</b><br>
              M·ª±c n∆∞·ªõc ban ƒë·∫ßu: <b>${res.z0.toFixed(2)} m</b><br>
              Ng∆∞·ª°ng gi·ªõi h·∫°n l≈©: <b>${res.limit.toFixed(2)} m</b><br><br>
              <table>
                <thead>
                  <tr>
                    <th>K·ªãch b·∫£n</th>
                    <th>M∆∞a (mm)</th>
                    <th>Z sau 6h (m)</th>
                    <th>Z sau 12h (m)</th>
                    <th>Z sau 24h (m)</th>
                  </tr>
                </thead>
                <tbody>`;
  resultRows.forEach(r=>{
    html += `<tr>
      <td>${r.label}</td>
      <td>${r.rain.toFixed(1)}</td>
      <td>${r.z6.toFixed(2)}</td>
      <td>${r.z12.toFixed(2)}</td>
      <td>${r.z24.toFixed(2)}</td>
    </tr>`;
  });
  html += `</tbody></table>`;
  document.getElementById("aiResult").innerHTML = html;
  document.getElementById("aiResult").style.display = "block";

  // Kh·ªëi an to√†n h·ªì
  const safetyDiv = document.getElementById("safetyResult");
  safetyDiv.innerHTML = `
    <b>ƒê√°nh gi√° an to√†n h·ªì (k·ªãch b·∫£n m∆∞a d·ª± ki·∫øn):</b><br>
    M·ª±c n∆∞·ªõc sau 24h: <b>${base24.toFixed(2)} m</b> ‚Äî
    <span class="badge ${safety.badgeClass}">${safety.level}</span><br>
    Ch·ªâ s·ªë an to√†n t∆∞∆°ng ƒë·ªëi: <b>${(safety.safetyIndex*100).toFixed(1)}%</b><br><br>
    üîé Khuy·∫øn ngh·ªã v·∫≠n h√†nh:<br>
    ${safety.advice}<br><br>
    ü§ñ G·ª£i √Ω x·∫£: n√™n x·∫£ kho·∫£ng <b>${qOpt.toFixed(0)} m¬≥/s</b> (trong gi·ªõi h·∫°n t·ªëi ƒëa ${res.qMax} m¬≥/s),
    ƒë·ªìng th·ªùi theo d√µi m·ª±c n∆∞·ªõc th·ª±c t·∫ø v√† c·∫≠p nh·∫≠t d·ª± b√°o.
  `;
  safetyDiv.style.display = "block";

  // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì
  updateChart(times, seriesLow, seriesBase, seriesHigh);

  // L∆∞u l·∫°i cho PDF
  lastForecast = {
    reservoirKey: key,
    reservoirName: res.name,
    rainInput: rain,
    qIn,
    qOut,
    scenarios: resultRows,
    qOutOpt: qOpt,
    safety
  };

  // ƒê·ªìng b·ªô sang tab b√°o c√°o
  document.getElementById("repName").value = res.name;
  document.getElementById("repNow").value = res.z0.toFixed(2);
  document.getElementById("repFuture").value = base24.toFixed(2);
  document.getElementById("repLevel").value = safety.level;
}

// =========================
//  BI·ªÇU ƒê·ªí Chart.js
// =========================
function updateChart(times, lowData, baseData, highData){
  const ctx = document.getElementById("forecastChart").getContext("2d");
  document.getElementById("chartContainer").style.display = "block";

  const data = {
    labels: times.map(t=>t+"h"),
    datasets: [
      {
        label: "M∆∞a th·∫•p (70%)",
        data: lowData,
        borderWidth: 2,
        fill:false
      },
      {
        label: "M∆∞a d·ª± ki·∫øn (100%)",
        data: baseData,
        borderWidth: 2,
        fill:false
      },
      {
        label: "M∆∞a c·ª±c ƒëoan (150%)",
        data: highData,
        borderWidth: 2,
        fill:false
      }
    ]
  };

  const options = {
    responsive:true,
    plugins:{legend:{position:"bottom"}},
    scales:{y:{title:{display:true,text:"M·ª±c n∆∞·ªõc (m)"}}}
  };

  if (chartInstance){
    chartInstance.data = data;
    chartInstance.options = options;
    chartInstance.update();
  } else {
    chartInstance = new Chart(ctx, {
      type:"line",
      data,
      options
    });
  }
}

// =========================
//  M√î PH·ªéNG LI√äN H·ªí (ƒê∆†N GI·∫¢N)
// =========================
function simulateFlow(){
  const rain = Number(document.getElementById("rainFlow").value);
  const baseFlow = rain * 0.8;
  const nganTruoiOut = baseFlow * 0.9;
  const keGoOut = nganTruoiOut * 0.85;
  const songLaRise = (keGoOut / 110).toFixed(2);

  const html = `
  üíß <b>D√≤ng ch·∫£y m√¥ ph·ªèng (s∆° b·ªô):</b><br>
  - Ng√†n Tr∆∞∆°i x·∫£: <b>${nganTruoiOut.toFixed(2)} m¬≥/s</b><br>
  - K·∫ª G·ªó nh·∫≠n: <b>${keGoOut.toFixed(2)} m¬≥/s</b><br>
  - M·ª±c n∆∞·ªõc S√¥ng La d√¢ng: <b>${songLaRise} m</b><br><br>
  ‚è±Ô∏è Sau ~3h: n∆∞·ªõc t·ª´ Ng√†n Tr∆∞∆°i t·ªõi K·∫ª G·ªó<br>
  ‚è±Ô∏è Sau ~5h: S√¥ng La ƒë·∫°t ƒë·ªânh kho·∫£ng ${songLaRise} m<br>
  ‚ö†Ô∏è Khu v·ª±c ƒê·ª©c Th·ªç & H·ªìng Lƒ©nh c·∫ßn c·∫£nh b√°o m·ª©c 2, theo d√µi l∆∞u l∆∞·ª£ng v·ªÅ.
  `;
  document.getElementById("flowResult").innerHTML = html;
  document.getElementById("flowResult").style.display = "block";
}

// =========================
//  XU·∫§T PDF N√ÇNG CAO
// =========================
async function exportPDF(){
  if (!lastForecast){
    alert("Ch∆∞a c√≥ k·∫øt qu·∫£ d·ª± b√°o. Vui l√≤ng sang tab üß† AI D·ª± b√°o ƒë·ªÉ ch·∫°y d·ª± b√°o tr∆∞·ªõc.");
    return;
  }
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  const name = document.getElementById("repName").value || lastForecast.reservoirName;
  const now  = document.getElementById("repNow").value;
  const fut  = document.getElementById("repFuture").value;
  const levelText = document.getElementById("repLevel").value;

  // Ti√™u ƒë·ªÅ
  pdf.setFontSize(15);
  pdf.text("B√ÅO C√ÅO C·∫¢NH B√ÅO L≈® - SAFE ROUTE AI",10,15);

  pdf.setFontSize(11);
  pdf.text(`H·ªì ch·ª©a: ${name}`,10,25);
  pdf.text(`M·ª±c n∆∞·ªõc hi·ªán t·∫°i: ${now} m`,10,32);
  pdf.text(`D·ª± b√°o sau 24h (k·ªãch b·∫£n trung b√¨nh): ${fut} m`,10,39);
  pdf.text(`M·ª©c c·∫£nh b√°o: ${levelText}`,10,46);
  pdf.text(`Th·ªùi gian l·∫≠p b√°o c√°o: ${new Date().toLocaleString()}`,10,53);

  pdf.text("---------------------------------------------------------",10,60);
  pdf.text("1. K·∫øt qu·∫£ d·ª± b√°o 3 k·ªãch b·∫£n m∆∞a",10,68);

  let y = 76;
  pdf.setFontSize(10);
  pdf.text("K·ªãch b·∫£n              M∆∞a(mm)   Z6h(m)   Z12h(m)   Z24h(m)",10,y); y+=5;
  lastForecast.scenarios.forEach(s=>{
    const line = `${s.label.padEnd(19)} ${s.rain.toFixed(1).padStart(7)}   ${s.z6.toFixed(2).padStart(5)}   ${s.z12.toFixed(2).padStart(7)}   ${s.z24.toFixed(2).padStart(7)}`;
    pdf.text(line,10,y);
    y+=5;
  });

  y+=4;
  pdf.text("2. ƒê√°nh gi√° an to√†n & g·ª£i √Ω v·∫≠n h√†nh",10,y); y+=6;
  pdf.text(`- M·ª©c ƒë·ªô an to√†n: ${lastForecast.safety.level}`,10,y); y+=5;
  pdf.text(`- Ch·ªâ s·ªë an to√†n t∆∞∆°ng ƒë·ªëi: ${(lastForecast.safety.safetyIndex*100).toFixed(1)}%`,10,y); y+=5;
  pdf.text(`- G·ª£i √Ω Qout AI: ~${lastForecast.qOutOpt.toFixed(0)} m3/s (t√πy ƒëi·ªÅu ki·ªán th·ª±c t·∫ø)`,10,y); y+=5;

  // Ch√®n bi·ªÉu ƒë·ªì n·∫øu c√≥
  if (chartInstance){
    try{
      const canvas = document.getElementById("forecastChart");
      const imgData = canvas.toDataURL("image/png",1.0);
      pdf.text("3. Bi·ªÉu ƒë·ªì m·ª±c n∆∞·ªõc theo th·ªùi gian (3 k·ªãch b·∫£n):",10,y+5);
      pdf.addImage(imgData,"PNG",10,y+10,180,80);
    }catch(e){
      console.error("L·ªói khi th√™m bi·ªÉu ƒë·ªì v√†o PDF:",e);
    }
  }

  // Ch√¢n trang
  pdf.setFontSize(9);
  pdf.text("H·ªá th·ªëng AI Reservoir - H√† Tƒ©nh 2025",10,285);

  pdf.save("SafeRoute_Report_ReservoirAI_v4.pdf");
  document.getElementById("reportStatus").innerText="‚úÖ B√°o c√°o n√¢ng cao ƒë√£ ƒë∆∞·ª£c t·∫£i xu·ªëng.";
}

// =========================
//  G·ª¨I SOS
// =========================
function sendSOS(){
  const msg="üì° SOS kh·∫©n c·∫•p! C·∫£nh b√°o m·ª±c n∆∞·ªõc v∆∞·ª£t ng∆∞·ª°ng cho ph√©p!";
  alert(msg);
  document.getElementById("reportStatus").innerText="üö® SOS ƒë√£ g·ª≠i t·ªõi trung t√¢m c·ª©u h·ªô (m√¥ ph·ªèng).";
  console.log(msg);
}

// Kh·ªüi t·∫°o info ban ƒë·∫ßu
onReservoirChange();
</script>

</body>
</html>
